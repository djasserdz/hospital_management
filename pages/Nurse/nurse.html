<!DOCTYPE html>

<html dir="rtl" lang="ar">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>واجهة الممرض</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<style>
        body {
            font-family: 'Tajawal', 'Segoe UI', Tahoma, Arial, sans-serif;
            background-color: #f8f9fa;
            direction: rtl;
            text-align: right;
            height: 100vh;
            overflow: hidden;
            margin: 0;
        }

        .sidebar {
            width: 0;
            background: linear-gradient(180deg, #0288d1, #01579b);
            color: white;
            height: 100vh;
            position: fixed;
            top: 0;
            right: 0;
            padding: 0;
            transition: all 0.3s ease;
            overflow-y: auto;
            box-shadow: -3px 0 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }

        .sidebar.active {
            width: 250px;
            padding: 20px 15px;
        }

        .sidebar h2 {
            font-size: 1.6rem;
            margin-bottom: 30px;
            text-align: center;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .sidebar a {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            padding: 12px 15px;
            margin: 8px 0;
            border-radius: 8px;
            transition: all 0.3s ease;
            background-color: rgba(255, 255, 255, 0.1);
        }

        .sidebar a:hover {
            background-color: rgba(255, 255, 255, 0.3);
            transform: translateX(-5px);
        }

        .sidebar a i {
            margin-left: 12px;
            font-size: 1.2rem;
        }

        .content {
            margin-right: 0;
            margin-left: 0;
            padding: 20px;
            height: 100vh;
            overflow-y: auto;
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            width: 100%;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }

        .content.sidebar-active {
            margin-right: 250px;
            width: calc(100% - 250px);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .card {
            background-color: #fff;
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
            width: 100%;
            overflow-x: auto;
        }

        .card h3 {
            color: #0288d1;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .form-group label {
            font-weight: 500;
            color: #333;
        }

        .form-control,
        .form-select {
            border-radius: 5px;
        }

        .btn {
            border-radius: 5px;
            padding: 8px 20px;
            font-weight: 500;
        }

        .btn-primary {
            background-color: #0288d1;
            border-color: #0288d1;
        }

        .btn-primary:hover {
            background-color: #01579b;
            border-color: #01579b;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: #fff;
            border-radius: 5px;
            overflow: hidden;
            table-layout: auto;
        }

        th,
        td {
            border: 1px solid #dee2e6;
            padding: 12px;
            text-align: center;
            vertical-align: middle;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
            vertical-align: middle;
        }

        th {
            background-color: #0288d1;
            color: white;
            font-weight: 600;
        }

        .message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-weight: 500;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .notes-cell {
            position: relative;
        }

        .notes-icon {
            cursor: pointer;
            font-size: 1.2rem;
            color: #0288d1;
        }

        .notes-icon:hover {
            color: #01579b;
        }

        #searchBar {
            margin-bottom: 20px;
            width: 100%;
            max-width: 300px;
        }

        .update-info {
            font-size: 0.9rem;
            color: #333;
            background-color: #f8f9fa;
            padding: 5px 10px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            margin-bottom: 15px;
            text-align: right;
        }

        .patient-details-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            padding: 15px;
        }

        .patient-details-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .patient-details-section h6 {
            color: #0288d1;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .patient-details-section p {
            margin: 5px 0;
            font-size: 0.95rem;
            color: #333;
        }

        .room-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .room-icon {
            cursor: pointer;
            font-size: 1.1rem;
            color: #0288d1;
            transition: color 0.3s ease;
            padding: 4px;
            border-radius: 4px;
        }

        .room-icon:hover {
            color: #01579b;
            background-color: #e9ecef;
        }

        @media (max-width: 768px) {
            .sidebar.active {
                width: 70px;
                padding: 20px 10px;
            }

            .sidebar.active h2 {
                font-size: 1.2rem;
                margin-bottom: 20px;
            }

            .sidebar.active a {
                justify-content: center;
                padding: 12px 0;
            }

            .sidebar.active a span {
                display: none;
            }

            .sidebar.active a i {
                margin-left: 0;
                font-size: 1.4rem;
            }

            .content.sidebar-active {
                margin-right: 70px;
                width: calc(100% - 70px);
            }

            .patient-details-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .sidebar {
                width: 0;
                padding: 0;
                overflow: hidden;
            }

            .sidebar.active {
                width: 200px;
                padding: 20px 15px;
            }

            .content.sidebar-active {
                margin-right: 200px;
                width: calc(100% - 200px);
            }
        }
    </style>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&amp;display=swap" rel="stylesheet"/>
</head>
<body>
<button class="btn btn-primary" id="toggleSidebar" style="position: fixed; top: 10px; right: 10px; z-index: 1100;">☰</button>
<div class="sidebar">
<h2>واجهة الممرض</h2><a href="#" onclick="document.getElementById('addButton').click()"><i class="bi bi-person-plus"></i> <span>إضافة مريض</span></a>
<a href="#" onclick="showSection('manage-patients')"><i class="bi bi-person-check"></i> <span>إدارة
                المرضى</span></a>
<a href="#" onclick="showSection('all-patients')"><i class="bi bi-people"></i> <span>جميع المرضى</span></a>
<a href="#" onclick="logout()"><i class="bi bi-box-arrow-right"></i> <span>تسجيل الخروج</span></a>
</div>
<div class="content">
<h1 class="text-center mb-4" style="color: #0288d1;">واجهة الممرض</h1>
<!-- Manage Patients Section -->
<div class="section active" id="manage-patients">
<div class="card">
<h3>إدارة المرضى</h3>
<div class="message" id="patientMessage"></div>
<div class="input-group mb-3" style="max-width: 300px;">
<input class="form-control" id="searchBar" placeholder="ابحث باسم المريض أو رقم التعريف" type="text"/>
<button class="btn btn-primary" onclick="searchPatients('manage-patients')">بحث</button>
</div>
<table class="table table-striped table-hover" id="managePatientsTable">
<thead>
<tr>
<th>الاسم و اللقب</th>
<th>رقم الغرفة</th>
<th>الجنس</th>
<th>الحالة</th>
<th>التوصيات الطبية</th>
<th>تفاصيل حول المريض</th>
<th>الإجراءات</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>
<!-- All Patients Section -->
<div class="section" id="all-patients">
<div class="card">
<h3>جميع المرضى</h3>
<div class="message" id="allPatientsMessage"></div>
<div class="input-group mb-3" style="max-width: 300px;">
<input class="form-control" id="searchBarAll" placeholder="ابحث باسم المريض أو رقم التعريف" type="text"/>
<button class="btn btn-primary" onclick="searchPatients('all-patients')">بحث</button>
</div>
<table class="table table-striped table-hover" id="allPatientsTable">
<thead>
<tr>
<th>الاسم واللقب</th>
<th>اللقب</th>
<th>رقم الغرفة</th>
<th>الجنس</th>
<th>الحالة</th>
<th>الحالة النشطة</th>
<th>الإجراءات</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>
</div>
<!-- Update Patient Modal -->
<div aria-hidden="true" aria-labelledby="addPatientModalLabel" class="modal fade" id="addPatientModal" tabindex="-1">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="addPatientModalLabel">إضافة مريض جديد</h5>
<button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body">
<form class="row g-3" id="addPatientForm">
<div class="col-md-6">
<div class="form-group">
<label for="addName">الاسم</label>
<input class="form-control" id="addName" name="name" required="" type="text"/>
</div>
</div>
<div class="col-md-6">
<div class="form-group">
<label for="addSurname">اللقب</label>
<input class="form-control" id="addSurname" name="surname" required="" type="text"/>
</div>
</div>
<div class="col-md-6">
<div class="form-group">
<label for="addIdNumber">رقم التعريف</label>
<input class="form-control" id="addIdNumber" name="id_number" required="" type="text"/>
</div>
</div>
<div class="col-md-6">
<div class="form-group">
<label for="addPhoneNumber">رقم الهاتف</label>
<input class="form-control" id="addPhoneNumber" name="phone_number" required="" type="text"/>
</div>
</div>
<div class="col-md-6">
<div class="form-group">
<label for="addGender">الجنس</label>
<select class="form-select" id="addGender" name="gender" required="">
<option value="">اختر الجنس</option>
<option value="ذكر">ذكر</option>
<option value="أنثى">أنثى</option>
</select>
</div>
</div>
<div class="col-md-6">
<div class="form-group">
<label for="addBirthDate">تاريخ الميلاد</label>
<input class="form-control" id="addBirthDate" name="birth_date" required="" type="date"/>
</div>
</div>
<div class="col-md-6">
<div class="form-group">
<label for="addBloodType">زمرة الدم</label>
<select class="form-select" id="addBloodType" name="blood_type" required="">
<option value="">اختر زمرة الدم</option>
<option value="A+">A+</option>
<option value="A-">A-</option>
<option value="B+">B+</option>
<option value="B-">B-</option>
<option value="AB+">AB+</option>
<option value="AB-">AB-</option>
<option value="O+">O+</option>
<option value="O-">O-</option>
</select>
</div>
</div>
<div class="col-md-6">
<div class="form-group">
<label for="addRoom">رقم الغرفة</label>
<div class="input-group">
<input class="form-control" id="addRoom" name="room" readonly="" required="" type="text"/>
<button class="btn btn-primary" data-bs-target="#selectRoomModalAdd" data-bs-toggle="modal" type="button">اختر غرفة</button>
</div>
</div>
</div>
<div class="col-md-6">
<div class="form-group">
<label for="addStatus">الحالة</label>
<select class="form-select" id="addStatus" name="status" required="">
<option value="">اختر الحالة</option>
<option value="حالة مستقرة">حالة مستقرة</option>
<option value="حالة حرجة">حالة حرجة</option>
<option value="حالة خطيرة">حالة خطيرة</option>
<option value="حالة غير مستقرة">حالة غير مستقرة</option>
<option value="حالة وفاة سريرية">حالة وفاة سريرية</option>
<option value="حالة وفاة">حالة وفاة</option>
</select>
</div>
</div>
<div class="col-md-12">
<div class="form-group">
<label>الأدوية</label>
<div id="addRecommendations">
<div class="input-group mb-2 recommendation-item">
<input class="form-control" name="medication[]" placeholder="الدواء" type="text"/>
<input class="form-control" name="dosage[]" placeholder="الجرعة" type="text"/>
<button class="btn btn-outline-danger" onclick="removeRecommendation(this)" type="button">حذف</button>
</div>
</div>
<button class="btn btn-outline-primary mt-2" onclick="addRecommendation('addRecommendations')" type="button">إضافة دواء</button>
</div>
</div>
<!-- البيانات الحيوية -->
<div class="col-md-6">
<div class="form-group">
<label for="addTemperature">درجة الحرارة (°C)</label>
<input class="form-control" id="addTemperature" name="temperature" placeholder="مثال: 36.5" step="0.1" type="number"/>
</div>
</div>
<div class="col-md-6">
<div class="form-group">
<label for="addHeartRate">معدل ضربات القلب (نبضة/دقيقة)</label>
<input class="form-control" id="addHeartRate" name="heart_rate" placeholder="مثال: 80" type="number"/>
</div>
</div>
<div class="col-md-6">
<div class="form-group">
<label for="addRespiratoryRate">معدل التنفس (نفس/دقيقة)</label>
<input class="form-control" id="addRespiratoryRate" name="respiratory_rate" placeholder="مثال: 16" type="number"/>
</div>
</div>
<div class="col-md-6">
<div class="form-group">
<label for="addBloodPressure">ضغط الدم (mmHg)</label>
<input class="form-control" id="addBloodPressure" name="blood_pressure" placeholder="مثال: 120/80" type="text"/>
</div>
</div>
<div class="col-md-6">
<div class="form-group">
<label for="addOxygenSaturation">نسبة الأكسجين في الدم (%)</label>
<input class="form-control" id="addOxygenSaturation" name="oxygen_saturation" placeholder="مثال: 98" type="number"/>
</div>
</div>
<div class="col-md-6">
<div class="form-group">
<label for="addWeight">الوزن (كجم)</label>
<input class="form-control" id="addWeight" name="weight" placeholder="مثال: 70" step="0.1" type="number"/>
</div>
</div>
<div class="col-md-6">
<div class="form-group">
<label for="addHeight">الطول (سم)</label>
<input class="form-control" id="addHeight" name="height" placeholder="مثال: 170" type="number"/>
</div>
</div>
</form>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" data-bs-dismiss="modal" type="button">إغلاق</button>
<button class="btn btn-primary" id="addButton" type="button">إضافة</button>
</div>
</div>
</div>
</div><div aria-hidden="true" aria-labelledby="updatePatientModalLabel" class="modal fade" id="updatePatientModal" tabindex="-1">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="updatePatientModalLabel">تحديث بيانات المريض</h5>
<button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body">
<form class="row g-3" id="updatePatientForm">
<!-- Status -->
<div class="col-md-6">
<label for="updateStatus">الحالة</label>
<select class="form-select" id="updateStatus" name="etat_santee" required="">
<option value="">اختر الحالة</option>
<option value="حالة مستقرة">حالة مستقرة</option>
<option value="حالة حرجة">حالة حرجة</option>
<option value="حالة خطيرة">حالة خطيرة</option>
<option value="حالة غير مستقرة">حالة غير مستقرة</option>
<option value="حالة وفاة سريرية">حالة وفاة سريرية</option>
<option value="حالة وفاة">حالة وفاة</option>
</select>
</div>
<div class="col-md-12">
<label>الأدوية</label>
<div id="prescriptions">
<div class="input-group mb-2 prescription-item">
<input class="form-control" name="medicament[]" placeholder="الدواء" type="text"/>
<input class="form-control" name="dosage[]" placeholder="الجرعة" type="text"/>
<input class="form-control" name="frequency[]" placeholder="التردد" type="text"/>
<input class="form-control" name="instruction[]" placeholder="تعليمات" type="text"/>
<button class="btn btn-outline-danger" onclick="removePrescription(this)" type="button">حذف</button>
</div>
</div>
<button class="btn btn-outline-primary mt-2" onclick="addPrescription()" type="button">إضافة دواء</button>
</div>
<!-- Suivi / Vital Signs -->
<div class="col-md-6">
<label for="updateTension">ضغط الدم (mmHg)</label>
<input class="form-control" id="updateTension" name="tension" placeholder="مثال: 120/80" type="text"/>
</div>
<div class="col-md-6">
<label for="updateTemperature">درجة الحرارة (°C)</label>
<input class="form-control" id="updateTemperature" name="temperature" placeholder="مثال: 36.5" step="0.1" type="number"/>
</div>
<div class="col-md-6">
<label for="updateFrequenceCardiaque">معدل ضربات القلب (نبضة/دقيقة)</label>
<input class="form-control" id="updateFrequenceCardiaque" name="frequence_quardiaque" placeholder="مثال: 80" type="number"/>
</div>
<div class="col-md-6">
<label for="updateSaturationOxygene">نسبة الأكسجين في الدم (%)</label>
<input class="form-control" id="updateSaturationOxygene" name="saturation_oxygene" placeholder="مثال: 98" type="number"/>
</div>
<div class="col-md-6">
<label for="updateGlycemie">مستوى الجلوكوز في الدم (mg/dL)</label>
<input class="form-control" id="updateGlycemie" name="glycemie" placeholder="مثال: 90" step="0.1" type="number"/>
</div>
<div class="col-md-12">
<label for="updateRemarque">ملاحظات</label>
<textarea class="form-control" id="updateRemarque" name="Remarque" placeholder="أدخل ملاحظات إضافية" rows="3"></textarea>
</div>
<!-- Date of Observation -->
<div class="col-md-6">
<label for="updateDateObservation">تاريخ الملاحظة</label>
<input class="form-control" id="updateDateObservation" name="Date_observation" type="datetime-local"/>
</div>
<div class="col-md-6">
    <label for="updateWeight">الوزن (كجم)</label>
    <input class="form-control" id="updateWeight" name="weight" placeholder="مثال: 70" step="0.1" type="number"/>
</div>
<div class="col-md-6">
    <label for="updateHeight">الطول (سم)</label>
    <input class="form-control" id="updateHeight" name="height" placeholder="مثال: 170" type="number"/>
</div>
</form>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" data-bs-dismiss="modal" type="button">إغلاق</button>
<button class="btn btn-primary" id="updateButton" type="button">تحديث</button>
</div>
</div>
</div>
</div>
<!-- Select Room Modal for Add -->
<div aria-hidden="true" aria-labelledby="selectRoomModalAddLabel" class="modal fade" id="selectRoomModalAdd" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="selectRoomModalAddLabel">اختر غرفة</h5>
<button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body">
<div class="row" id="availableRoomsAdd"></div>
</div>
</div>
</div>
</div>
<!-- View Recommendations Modal -->
<div aria-hidden="true" aria-labelledby="viewRecommendationsModalLabel" class="modal fade" id="viewRecommendationsModal" tabindex="-1">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="viewRecommendationsModalLabel">التوصيات الطبية</h5>
<button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body" id="viewRecommendationsContent"></div>
<div class="modal-footer">
<button class="btn btn-secondary" data-bs-dismiss="modal" type="button">إغلاق</button>
</div>
</div>
</div>
</div>
<!-- View Patient Details Modal -->
<div aria-hidden="true" aria-labelledby="viewPatientDetailsModalLabel" class="modal fade" id="viewPatientDetailsModal" tabindex="-1">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="viewPatientDetailsModalLabel">تفاصيل المريض</h5>
<button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body" id="viewPatientDetailsContent"></div>
<div class="modal-footer">
<button class="btn btn-secondary" data-bs-dismiss="modal" type="button">إغلاق</button>
</div>
</div>
</div>
</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
        // DOM Elements
const patientMessage = document.getElementById('patientMessage');
const allPatientsMessage = document.getElementById('allPatientsMessage');
const managePatientsTable = document.getElementById('managePatientsTable').getElementsByTagName('tbody')[0];
const allPatientsTable = document.getElementById('allPatientsTable').getElementsByTagName('tbody')[0];
const updateButton = document.getElementById('updateButton');
const updatePatientModal = document.getElementById('updatePatientModal');
const viewRecommendationsModal = document.getElementById('viewRecommendationsModal');
const selectRoomModalAdd = document.getElementById('selectRoomModalAdd');
const sidebar = document.querySelector('.sidebar');
const toggleSidebarBtn = document.getElementById('toggleSidebar');
const content = document.querySelector('.content');

// Global Variables
let selectedPatientId = null;
let selectedSejourId = null;
let isAddMode = false;

// Utility Functions
function showMessage(text, type) {
    if (patientMessage) {
        patientMessage.textContent = text;
        patientMessage.className = `message ${type}`;
        patientMessage.style.display = 'block';
        setTimeout(() => patientMessage.style.display = 'none', 3000);
    }
}

function showMessageAll(text, type) {
    if (allPatientsMessage) {
        allPatientsMessage.textContent = text;
        allPatientsMessage.className = `message ${type}`;
        allPatientsMessage.style.display = 'block';
        setTimeout(() => allPatientsMessage.style.display = 'none', 3000);
    }
}

// Prescription Management
function addPrescription() {
    const container = document.getElementById('prescriptions');
    if (!container) return;
    
    const div = document.createElement('div');
    div.classList.add('input-group', 'mb-2', 'prescription-item');
    div.innerHTML = `
        <input type="text" class="form-control" placeholder="الدواء" name="medicament[]">
        <input type="text" class="form-control" placeholder="الجرعة" name="dosage[]">
        <input type="text" class="form-control" placeholder="التردد" name="frequency[]">
        <input type="text" class="form-control" placeholder="تعليمات" name="instruction[]">
        <button type="button" class="btn btn-outline-danger" onclick="removePrescription(this)">حذف</button>
    `;
    container.appendChild(div);
}

function removePrescription(button) {
    if (button && button.parentElement) {
        button.parentElement.remove();
    }
}

// Room Management
function openRoomSelection(sejourId = null) {
    selectedSejourId = sejourId;
    const nurse = JSON.parse(localStorage.getItem('loggedInUser'));
    if (nurse && nurse.id) {
        loadAvailableRooms(nurse.id);
    } else {
        showMessage('خطأ في بيانات المستخدم', 'error');
    }
}

async function loadAvailableRooms(nurse_id) {
    try {
        const response = await axios.get('/nurse/room', {
            params: { nurse_id: nurse_id }
        });
        
        console.log(response);
        const rooms = response.data;
        
        if (!Array.isArray(rooms) || rooms.length === 0) {
            showMessage('لا توجد غرف متاحة', 'info');
            return;
        }
        
        // Create modal for room selection
        showRoomSelectionModal(rooms);
        
    } catch (error) {
        console.error('Error loading rooms:', error);
        showMessage('حدث خطأ أثناء تحميل الغرف', 'error');
    }
}

function showRoomSelectionModal(rooms) {
    // Create modal HTML
    const modalHTML = `
        <div class="modal fade" id="roomSelectionModal" tabindex="-1" aria-labelledby="roomSelectionModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="roomSelectionModalLabel">اختر غرفة</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row" id="roomOptionsContainer">
                            <!-- Room options will be inserted here -->
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('roomSelectionModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Populate room options
    const container = document.getElementById('roomOptionsContainer');
    rooms.forEach(room => {
        const roomNumber = room.numero_cr || 'غير محدد';
        const bedNumber = room.numero_lit || '';
        const displayText = bedNumber ? `غرفة ${roomNumber} - سرير ${bedNumber}` : `غرفة ${roomNumber}`;
        
        const roomOption = document.createElement('div');
        roomOption.className = 'col-6 mb-2';
        roomOption.innerHTML = `
            <button type="button" class="btn btn-outline-primary w-100 room-option-btn" data-room='${JSON.stringify(room)}'>
                ${displayText}
            </button>
        `;
        container.appendChild(roomOption);
    });
    
    // Add click handlers for room selection
    document.querySelectorAll('.room-option-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const roomData = JSON.parse(this.getAttribute('data-room'));
            selectRoomForPatient(roomData);
        });
    });
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('roomSelectionModal'));
    modal.show();
    
    // Clean up modal after it's hidden
    document.getElementById('roomSelectionModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

function selectRoomForPatient(room) {
    if (!selectedSejourId) {
        showMessage('خطأ في تحديد الإقامة', 'error');
        return;
    }

    const nurse = JSON.parse(localStorage.getItem('loggedInUser'));
    if (!nurse || !nurse.id) {
        showMessage('خطأ في بيانات المستخدم', 'error');
        return;
    }

    // Update room assignment
    axios.put('/sejour/room', {
        id_sejour: selectedSejourId,
        id_chambre: room.id_chambre || room.room_id,
        id_agent: nurse.id
    })
    .then(response => {
        if (response.status === 200) {
            loadManagePatients();
            showMessage('تم تحديث رقم الغرفة بنجاح', 'success');
        } else {
            showMessage('فشل في تحديث الغرفة', 'error');
        }
    })
    .catch(error => {
        console.error('Error updating room:', error);
        showMessage('حدث خطأ أثناء التحديث', 'error');
    })
    .finally(() => {
        // Close the room selection modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('roomSelectionModal'));
        if (modal) modal.hide();
    });
}

// Patient Data Loading
async function loadManagePatients() {
    try {
        const nurse = JSON.parse(localStorage.getItem('loggedInUser'));
        if (!nurse || !nurse.id) {
            showMessage('خطأ في بيانات المستخدم', 'error');
            return;
        }

        const response = await axios.get(`/nurse/patients?nurse_id=${nurse.id}`);
        
        const patientsData = response.data.data || response.data;
        const patients = Array.isArray(patientsData) ? patientsData : [];
        
        console.log("Manage Patients Data:", patients);
        displayPatients(managePatientsTable, patients, true);

    } catch (error) {
        console.error('Error loading patients:', error);
        showMessage('حدث خطأ أثناء تحميل المرضى', 'error');
    }
}

async function loadAllPatients() {
    try {
        const nurse = JSON.parse(localStorage.getItem('loggedInUser'));
        if (!nurse || !nurse.id) {
            showMessageAll('خطأ في بيانات المستخدم', 'error');
            return;
        }

        const response = await axios.get(`/nurse/patients?nurse_id=${nurse.id}`);
        
        const patientsData = response.data.data || response.data;
        const patients = Array.isArray(patientsData) ? patientsData : [];
        
        console.log("All Patients Data:", patients);
        displayPatients(allPatientsTable, patients, false);
        
    } catch (error) {
        console.error('Error loading patients:', error);
        showMessageAll('حدث خطأ أثناء تحميل المرضى', 'error');
    }
}

function displayPatients(table, patientsList, isManageSection) {
    if (!table) return;

    console.log("displayPatients received:", patientsList);
    table.innerHTML = '';

    if (!Array.isArray(patientsList) || patientsList.length === 0) {
        const row = table.insertRow();
        const cell = row.insertCell();
        cell.colSpan = 7; // Default colspan, adjust if more columns are shown for nurse view
        cell.textContent = 'لا توجد بيانات للعرض';
        cell.style.textAlign = 'center';
        return;
    }

    patientsList.forEach(patient => {
        const row = table.insertRow();

        const patientName = patient.full_name || '-';
        // Construct room display string
        let roomDisplay = '';
        if (patient.room_number) {
            roomDisplay += patient.room_number;
            if (patient.room_bed_number) {
                roomDisplay += ` (سرير ${patient.room_bed_number})`;
            }
        } else {
            roomDisplay = '-';
        }
        const patientId = patient.id_patient;
        const sejourId = patient.id_sejour;
        const serviceNameToDisplay = patient.service_name || '-';
        const dischargeDate = patient.Date_sortiee;
        // The room ID associated with the sejour, needed for reactivation.
        // Ensure this is being sent from the backend in Nurse->getAllPatients()
        const sejourChambreId = patient.sejour_id_chambre || patient.room_id; 
        const serviceIdForReactivation = patient.service_id || patient.id_service_for_reactivation; // Prefer a specific field if available

        let statusText;
        let actionButtonHtml;

        if (dischargeDate) {
            statusText = `تم الخروج بتاريخ ${new Date(dischargeDate).toLocaleDateString()}`;
            actionButtonHtml = `<button class="btn btn-success btn-sm"
                                       onclick="updatePatientStayStatus(${sejourId}, 'reactivate', null, ${serviceIdForReactivation || 'undefined'})"> 
                                   إعادة التفعيل
                               </button>`;
        } else {
            statusText = 'نشط';
            actionButtonHtml = `<button class="btn btn-warning btn-sm"
                                       onclick="updatePatientStayStatus(${sejourId}, 'discharge', ${sejourChambreId})">
                                   إنهاء الإقامة
                               </button>`;
        }

        if (isManageSection) {
            let actionButtons = `
                <button class="btn btn-primary btn-sm"
                        onclick="openUpdateModal(${patientId}, ${sejourId})"
                        data-bs-toggle="modal"
                        data-bs-target="#updatePatientModal">
                    تحديث
                </button>
            `;
            // Add discharge button for active patients (no dischargeDate)
            if (!dischargeDate) {
                actionButtons += `
                `;
            }
            row.innerHTML = `
                <td>${patientName}</td>
                <td class="room-cell">
                    ${roomDisplay} 
                </td>
                <td>${patient.sex === 'homme' ? 'ذكر' : (patient.sex === 'famme' ? 'أنثى' : '-')}</td>
                <td>${patient.latest_etat_santee || '-'}</td>
                <td class="notes-cell">
                    <i class="bi bi-eye notes-icon"
                       onclick="viewRecommendations(${sejourId})"
                       title="عرض التوصيات"
                       data-bs-toggle="modal"
                       data-bs-target="#viewRecommendationsModal"></i>
                </td>
                <td>
                    <i class="bi bi-eye notes-icon"
                       onclick="viewPatientDetails(${patientId})"
                       title="عرض التفاصيل"
                       data-bs-toggle="modal"
                       data-bs-target="#viewPatientDetailsModal"></i>
                </td>
                <td>
                    ${actionButtons}
                </td>
            `;
        } else { // This is for allPatientsTable
            row.innerHTML = `
                <td>${patientName}</td>
                <td>${patient.NIN || '-'}</td>
                <td>${roomDisplay}</td>
                <td>${patient.sex === 'homme' ? 'ذكر' : (patient.sex === 'famme' ? 'أنثى' : '-')}</td>
                <td>${serviceNameToDisplay}</td>
                <td>${statusText}</td>
                <td>${actionButtonHtml}</td>
            `;
        }
    });
}

// Modal Functions
async function openUpdateModal(patientId, sejourId) {
    selectedPatientId = patientId;
    selectedSejourId = sejourId;

    const form = document.getElementById('updatePatientForm');
    if (form) {
        form.reset(); // Reset form to clear previous entries
    }

    const prescriptionsContainer = document.getElementById('prescriptions');
    if (prescriptionsContainer) {
        prescriptionsContainer.innerHTML = ''; // Clear existing prescription rows before populating
    }

    // Set current date-time for observation for the new Suivi entry
    const dateObservationInput = document.getElementById('updateDateObservation');
    if (dateObservationInput) {
        const now = new Date();
        const localDateTime = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
        dateObservationInput.value = localDateTime;
    }

    if (!selectedSejourId) {
        showMessage('لم يتم تحديد الإقامة لتحميل بياناتها.', 'error');
        // Add a default empty prescription row if sejourId is missing, so the form is usable for a new patient scenario if ever adapted.
        addPrescription();
        return;
    }

    try {
        const response = await axios.get('/sejour/modal-details', {
            params: { id_sejour: selectedSejourId }
        });
        const modalData = response.data;

        // Populate Prescriptions
        if (modalData.prescriptions && modalData.prescriptions.length > 0) {
            modalData.prescriptions.forEach(p => {
                addPrescription(); // Add a new row
                const newRow = prescriptionsContainer.lastElementChild; // Get the newly added row
                if (newRow) {
                    newRow.querySelector('input[name="medicament[]"]').value = p.Medicament || '';
                    newRow.querySelector('input[name="dosage[]"]').value = p.Dosage || '';
                    newRow.querySelector('input[name="frequency[]"]').value = p.frequence || ''; // Ensure correct key from backend
                    newRow.querySelector('input[name="instruction[]"]').value = p.instructions || ''; // Ensure correct key
                }
            });
        } else {
            addPrescription(); // Add at least one empty row if no prescriptions exist
        }

        // Populate Suivi Data from latest_suivi if available
        if (modalData.latest_suivi) {
            const latestSuivi = modalData.latest_suivi;
            document.getElementById('updateStatus').value = latestSuivi.etat_santee || '';
            document.getElementById('updateTension').value = latestSuivi.tension || '';
            document.getElementById('updateTemperature').value = latestSuivi.temperature || '';
            document.getElementById('updateFrequenceCardiaque').value = latestSuivi.frequence_quardiaque || '';
            document.getElementById('updateSaturationOxygene').value = latestSuivi.saturation_oxygene || '';
            document.getElementById('updateGlycemie').value = latestSuivi.glycemie || '';
            document.getElementById('updateRemarque').value = latestSuivi.Remarque || ''; // This will prefill the main Remarque
            document.getElementById('updateWeight').value = latestSuivi.poids || '';
            document.getElementById('updateHeight').value = latestSuivi.taille || '';
            // updateDiagnosis and updateTreatmentMethod are general textareas, not directly from latest_suivi object.
            // They will be part of the new Remarque or handled separately if needed.
            // The dateObservationInput is already set to 'now' for the new Suivi record.
        }
        // If modalData.latest_suivi is null, the fields (except date) will remain blank from form.reset(), which is fine.

    } catch (error) {
        console.error('Error fetching details for update modal:', error);
        showMessage('حدث خطأ أثناء تحميل بيانات التحديث.', 'error');
        // Ensure at least one prescription row is available even if data load fails
        if (prescriptionsContainer.children.length === 0) {
            addPrescription();
        }
    }
}

async function saveUpdatedPatient() {
    try {
        if (!selectedSejourId) {
            throw new Error('لم يتم تحديد الإقامة');
        }

        const nurse = JSON.parse(localStorage.getItem('loggedInUser'));
        if (!nurse || !nurse.id) {
            throw new Error('خطأ في بيانات المستخدم');
        }

        // Collect prescriptions
        const prescriptions = [];
        const prescriptionItems = document.querySelectorAll('#prescriptions .prescription-item');
        prescriptionItems.forEach(item => {
            const medicament = item.querySelector('input[name="medicament[]"]')?.value?.trim();
            const dosage = item.querySelector('input[name="dosage[]"]')?.value?.trim();
            const frequency = item.querySelector('input[name="frequency[]"]')?.value?.trim();
            const instruction = item.querySelector('input[name="instruction[]"]')?.value?.trim();
            
            if (medicament || dosage || frequency || instruction) {
                prescriptions.push({ medicament, dosage, frequency, instruction });
            }
        });

        // Collect form data
        const status = document.getElementById('updateStatus')?.value;
        const tension = document.getElementById('updateTension')?.value?.trim();
        const temperature = parseFloat(document.getElementById('updateTemperature')?.value) || null;
        const frequenceCardiaque = parseInt(document.getElementById('updateFrequenceCardiaque')?.value) || null;
        const saturationOxygene = parseInt(document.getElementById('updateSaturationOxygene')?.value) || null;
        const glycemie = parseFloat(document.getElementById('updateGlycemie')?.value) || null;
        const remarque = document.getElementById('updateRemarque')?.value?.trim();
        const dateObservation = document.getElementById('updateDateObservation')?.value;
        const weight = parseFloat(document.getElementById('updateWeight')?.value) || null;
        const height = parseFloat(document.getElementById('updateHeight')?.value) || null;

        if (!status) {
            throw new Error('يرجى تحديد حالة المريض');
        }

        // Update prescriptions: Delete all existing for the sejour, then add new ones.
        try {
            // 1. Fetch existing prescriptions for this sejour
            const existingPrescriptionsResponse = await axios.get('/prescriptions', {
                params: { id_sejour: selectedSejourId }
            });
            const existingPrescriptions = existingPrescriptionsResponse.data.prescriptions; // Assuming the backend wraps it in a 'prescriptions' key

            if (existingPrescriptions && existingPrescriptions.length > 0) {
                // 2. Delete each existing prescription by its id_prescription
                for (const prescription of existingPrescriptions) {
                    if (prescription.id_prescription) { // Ensure id_prescription exists
                        await axios.delete('/prescription', { 
                            params: { id: prescription.id_prescription } 
                        });
                        console.log('Deleted existing prescription ID:', prescription.id_prescription);
                    } else {
                        console.warn('Found existing prescription without id_prescription:', prescription);
                    }
                }
            }
        } catch (fetchDeleteError) {
            console.error('Error fetching or deleting existing prescriptions:', fetchDeleteError);
            // Decide if you want to stop or continue if deleting old prescriptions fails.
            // For now, we'll log and continue to try adding the new ones.
        }
        
        // 3. Add new prescriptions from the form
        if (prescriptions.length > 0) {
            try {
                for (const prescription of prescriptions) {
                    const response = await axios.post('/prescription', {
                        id_sejour: selectedSejourId,
                        Medicament: prescription.medicament || '',
                        Dosage: prescription.dosage || '',
                        frequence: prescription.frequency || '',
                        instructions: prescription.instruction || ''
                    });
                    console.log('Added new prescription:', response);
                }
            } catch (addPrescriptionError) {
                console.error('New prescription adding error:', addPrescriptionError);
                // Continue with suivi creation even if prescription update fails, but log error
            }
        }

        // Create suivi record
        const suiviData = {
            Date_observation: dateObservation || new Date().toISOString().slice(0, 19).replace('T', ' '),
            id_sejour: selectedSejourId,
            id_nurse: nurse.id,
            etat_santee: status,
            tension: tension || null,
            temperature: temperature,
            frequence_quardiaque: frequenceCardiaque,
            saturation_oxygene: saturationOxygene,
            glycemie: glycemie,
            Remarque: remarque || null,
            poids: weight,
            taille: height
        };

        const suiviResponse = await axios.post('/suivis', suiviData);
        console.log("suiviResponse:", suiviResponse);

        if (suiviResponse.status === 200 || suiviResponse.status === 201) {
            // Reload patient data
            await loadManagePatients();
            await loadAllPatients();
            
            // Close modal (assuming Bootstrap modal)
            const modal = bootstrap.Modal.getInstance(updatePatientModal);
            if (modal) modal.hide();
            
            showMessage('تم تحديث بيانات المريض بنجاح', 'success');
        } else {
            throw new Error('فشل في حفظ بيانات المتابعة');
        }

    } catch (error) {
        console.error('Error saving patient data:', error);
        showMessage(error.message || 'حدث خطأ أثناء التحديث', 'error');
    }
}


async function updatePatientStayStatus(sejourId, action, contextValue = null, serviceIdForReactivation = null) {
    if (!sejourId || !action) {
        let missingParam = !sejourId ? 'الإقامة' : 'الإجراء';
        showMessageAll(`خطأ في تحديد ${missingParam}`, 'error');
        console.error('Missing parameters for updatePatientStayStatus:', {sejourId, action, contextValue, serviceIdForReactivation});
        return;
    }

    try {
        const requestBody = {
            id_sejour: sejourId,
            action: action
        };

        if (action === 'discharge') {
            const chambreId = contextValue;
            if (!chambreId) {
                showMessageAll('خطأ: رقم الغرفة مطلوب لإنهاء الإقامة.', 'error');
                console.error('Missing chambreId for discharge in updatePatientStayStatus:', { sejourId, action });
                return;
            }
            requestBody.id_chambre = chambreId;
            requestBody.Date_sortie = new Date().toISOString().split('T')[0] + ' ' + new Date().toLocaleTimeString('en-GB');
        } else if (action === 'reactivate') {
            if (!serviceIdForReactivation) {
                showMessageAll('خطأ: معرف القسم مطلوب لإعادة تفعيل الإقامة.', 'error');
                console.error('Missing serviceIdForReactivation for reactivate in updatePatientStayStatus:', { sejourId, action });
                return;
            }
            requestBody.id_service = serviceIdForReactivation;
            // id_chambre is not sent for reactivate, backend handles room assignment within the provided service.
        } 

        const response = await axios.put('/sejour/status', requestBody);

        if (response.status === 200) {
            await loadManagePatients(); // Refresh both lists
            await loadAllPatients();
            const successMessage = action === 'discharge' ? 'تم إنهاء إقامة المريض بنجاح' : 'تمت إعادة تفعيل إقامة المريض بنجاح';
            showMessageAll(successMessage, 'success');
        } else {
            // The backend should send a meaningful message in response.data.message
            const errorMessage = response.data?.message || (action === 'discharge' ? 'فشل في تحديث حالة المريض' : 'فشل في إعادة تفعيل إقامة المريض');
            throw new Error(errorMessage);
        }
    } catch (error) {
        console.error('Error toggling patient status:', error);
        const displayMessage = error.response?.data?.message || error.message || 'حدث خطأ أثناء تغيير حالة المريض';
        showMessageAll(displayMessage, 'error');
    }
}

async function viewRecommendations(sejourId) {
    try {
        if (!sejourId) {
            showMessage('لم يتم تحديد الإقامة بشكل صحيح.', 'error');
            return;
        }
        console.log("viewRecommendations called for sejourId:", sejourId);

        // Fetch composite details (prescriptions and latest suivi)
        const response = await axios.get('/sejour/modal-details', {
            params: { id_sejour: sejourId }
        });
        
        console.log("Modal details response.data:", response.data);
        const modalData = response.data;

        const prescriptions = Array.isArray(modalData.prescriptions) ? modalData.prescriptions : [];
        const latestSuivi = modalData.latest_suivi;

        const content = document.getElementById('viewRecommendationsContent');
        if (!content) {
            console.error('Element with id "viewRecommendationsContent" not found.');
            return;
        }

        let suiviInfoHtml = '';
        if (latestSuivi) {
            let formattedSuiviDate = '-';
            if (latestSuivi.last_suivi_date) {
                const date = new Date(latestSuivi.last_suivi_date);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                formattedSuiviDate = `${year}-${month}-${day} ${hours}:${minutes}`;
            }
            suiviInfoHtml = `
                <div class="update-info mb-3">
                    <strong>آخر ملاحظة بتاريخ:</strong> ${formattedSuiviDate}<br>
                    <strong>بواسطة الممرض(ة):</strong> ${latestSuivi.last_suivi_by_nurse || '-'}
                </div>
                <h6>آخر ملاحظة (Remarque):</h6>
                <p class="border p-2 rounded bg-light">${latestSuivi.Remarque || 'لا توجد ملاحظات مسجلة.'}</p>
            `;
        }

        content.innerHTML = `
            ${suiviInfoHtml}
            <hr>
            <h5>الأدوية الموصوفة:</h5>
            <div class="prescription-list">
                ${prescriptions.length > 0
                    ? prescriptions.map(p => `
                        <div class="prescription-item mb-2 p-2 border rounded">
                            <strong>الدواء:</strong> ${p.Medicament || '-'}<br>
                            <strong>الجرعة:</strong> ${p.Dosage || '-'}<br>
                            <strong>التردد:</strong> ${p.frequence || '-'}<br>
                            <strong>التعليمات:</strong> ${p.instructions || '-'}
                        </div>
                    `).join('')
                    : '<p>لا توجد أدوية محددة لهذه الإقامة.</p>'
                }
            </div>
            `;

        // Update modal title if needed (e.g., include patient name if available from another source or added to modalData)
        const modalTitle = document.getElementById('viewRecommendationsModalLabel');
        if (modalTitle) {
            // To get patient name, you might need to pass it to viewRecommendations
            // or include it in the response from /sejour/modal-details if practical.
            modalTitle.textContent = `التوصيات والملاحظات الطبية للإقامة رقم: ${sejourId}`;
        }

    } catch (error) {
        console.error('Error loading recommendations/suivi details:', error);
        showMessage(error.response?.data?.message || 'حدث خطأ أثناء تحميل التفاصيل.', 'error');
    }
}


async function viewPatientDetails(patientId) {
    try {
        if (!patientId) {
            throw new Error('لم يتم تحديد المريض');
        }

        const response = await axios.get('/patient/detail', {
            params: { id: patientId }
        });
        
        const patientData = response.data;
        console.log('Patient details:', patientData);

        const patient = Array.isArray(patientData) ? patientData[0] : patientData;
        
        if (!patient) {
            throw new Error('لم يتم العثور على بيانات المريض');
        }

        const content = document.getElementById('viewPatientDetailsContent');
        if (!content) return;

        content.innerHTML = `
            <div class="patient-details-container">
                <div class="patient-details-section">
                    <h6>المعلومات الشخصية</h6>
                    <p><strong>الاسم الكامل:</strong> ${patient.full_name || `${patient.Nom || ''} ${patient.Prénom || ''}`.trim() || '-'}</p>
                    <p><strong>رقم التعريف:</strong> ${patient.NIN || '-'}</p>
                    <p><strong>رقم الهاتف:</strong> ${patient.telephone || patient.Tel || '-'}</p>
                    <p><strong>الجنس:</strong> ${patient.sex || patient.Gender || '-'}</p>
                    <p><strong>تاريخ الميلاد:</strong> ${patient.birth_date || '-'}</p>
                    <p><strong>زمرة الدم:</strong> ${patient.groupage || patient.Blood_type || '-'}</p>
                    <p><strong>العنوان:</strong> ${patient.adress || patient.address || '-'}</p>
                </div>
                <div class="patient-details-section">
                    <h6>البيانات الحيوية الأخيرة</h6>
                    <p><strong>درجة الحرارة:</strong> ${patient.Température || patient.temperature ? (patient.Température || patient.temperature) + ' °C' : '-'}</p>
                    <p><strong>معدل ضربات القلب:</strong> ${patient.frequence_quardiaque || patient.heart_rate ? (patient.frequence_quardiaque || patient.heart_rate) + ' نبضة/دقيقة' : '-'}</p>
                    <p><strong>ضغط الدم:</strong> ${patient.tension || patient.blood_pressure || '-'}</p>
                    <p><strong>نسبة الأكسجين:</strong> ${patient.saturation_oxygene || patient.oxygen_saturation ? (patient.saturation_oxygene || patient.oxygen_saturation) + '%' : '-'}</p>
                    <p><strong>مستوى الجلوكوز:</strong> ${patient.glycemie || patient.glucose_level ? (patient.glycemie || patient.glucose_level) + ' mg/dL' : '-'}</p>
                    <p><strong>الوزن:</strong> ${patient.poids || patient.weight ? (patient.poids || patient.weight) + ' كجم' : '-'}</p>
                    <p><strong>الطول:</strong> ${patient.taille || patient.height ? (patient.taille || patient.height) + ' متر' : '-'}</p>
                </div>
            </div>
        `;
        
        const modalTitle = document.getElementById('viewPatientDetailsModalLabel');
        if (modalTitle) {
            modalTitle.textContent = `تفاصيل المريض: ${patient.full_name || `${patient.Nom || ''} ${patient.Prénom || ''}`.trim() || 'غير محدد'}`;
        }

    } catch (error) {
        console.error('Error loading patient details:', error);
        showMessage('حدث خطأ أثناء تحميل تفاصيل المريض', 'error');
    }
}

let searchTimeout; // Ensure this is declared in a shared/global scope

async function searchPatients(sectionId) {
    clearTimeout(searchTimeout); // Prevent firing multiple times

    searchTimeout = setTimeout(async () => {
        try {
            const searchTerm = sectionId === 'manage-patients' ? 
                document.getElementById('searchBar')?.value?.trim()?.toLowerCase() : 
                document.getElementById('searchBarAll')?.value?.trim()?.toLowerCase();
            
            if (!searchTerm) {
                // Reload all patients if search is cleared
                if (sectionId === 'manage-patients') {
                    await loadManagePatients();
                } else {
                    await loadAllPatients();
                }
                return;
            }

            const nurse = JSON.parse(localStorage.getItem('loggedInUser'));
            if (!nurse?.id) {
                throw new Error('خطأ في بيانات المستخدم');
            }

            const nurse_id = nurse.id;

            const response = await axios.get("/nurse/patient/search", {
                params: {
                    nurse_id: nurse_id,
                    search: searchTerm,
                }
            });

            const patients = response.data; // response.data is now an array of patients

            // Ensure valid array is returned
            if (!Array.isArray(patients)) { // Check if it's an array
                console.error('Search did not return an array:', patients); // Log for debugging
                // Depending on desired behavior, you might want to show an error or an empty list
                displayPatients(sectionId === 'manage-patients' ? managePatientsTable : allPatientsTable, [], sectionId === 'manage-patients');
                throw new Error('لم يتم العثور على مرضى مطابقين أو حدث خطأ في البحث.'); // More specific error
            }

            if (sectionId === 'manage-patients') {
                // For manage-patients, filter for active sejours if needed (current logic seems to do this in displayPatients)
                // The backend searchPatient now returns patient details including sejour info for active ones.
                // So direct display might be fine, or an additional client filter for only those *currently* in a room if the backend returns more.
                // Assuming backend already filters correctly for active patients in nurse's service.
                displayPatients(managePatientsTable, patients, true);
            } else {
                displayPatients(allPatientsTable, patients, false);
            }

        } catch (error) {
            console.error('Error searching patients:', error);
            const errorMessage = 'حدث خطأ أثناء البحث';
            if (sectionId === 'manage-patients') {
                showMessage(errorMessage, 'error');
            } else {
                showMessageAll(errorMessage, 'error');
            }
        }
    }, 1000); // 1-second delay after user stops typing
}


// Navigation Functions
function logout() {
    localStorage.removeItem('loggedInUser');
    window.location.href = '/';
}

function showSection(sectionId) {
    // Hide all sections
    document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
    });
    
    // Show selected section
    const selectedSection = document.getElementById(sectionId);
    if (selectedSection) {
        selectedSection.classList.add('active');
    }
    
    // Load data for the section
    if (sectionId === 'manage-patients') {
        loadManagePatients();
    } else if (sectionId === 'all-patients') {
        loadAllPatients();
    }
}

// Event Listeners
document.addEventListener('DOMContentLoaded', function() {
    // Sidebar toggle
    if (toggleSidebarBtn) {
        toggleSidebarBtn.addEventListener('click', () => {
            sidebar?.classList.toggle('active');
            content?.classList.toggle('sidebar-active');
        });
    }

    // Update button
    if (updateButton) {
        updateButton.addEventListener('click', saveUpdatedPatient);
    }

    // Search bars
    const searchBar = document.getElementById('searchBar');
    if (searchBar) {
        searchBar.addEventListener('input', () => searchPatients('manage-patients'));
    }

    const searchBarAll = document.getElementById('searchBarAll');
    if (searchBarAll) {
        searchBarAll.addEventListener('input', () => searchPatients('all-patients'));
    }

    // Initialize page
    loadManagePatients();
    loadAllPatients();
});

// Handle page visibility changes
document.addEventListener('visibilitychange', function() {
    if (!document.hidden) {
        // Refresh data when page becomes visible
        loadManagePatients();
        loadAllPatients();
    }
});
</script>
</body>
</html>