<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>واجهة الممرض</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <style>
        body {
            font-family: 'Tajawal', 'Segoe UI', Tahoma, Arial, sans-serif;
            background-color: #f8f9fa;
            direction: rtl;
            text-align: right;
            height: 100vh;
            overflow: hidden;
            margin: 0;
        }

        .sidebar {
            width: 0;
            background: linear-gradient(180deg, #0288d1, #01579b);
            color: white;
            height: 100vh;
            position: fixed;
            top: 0;
            right: 0;
            padding: 0;
            transition: all 0.3s ease;
            overflow-y: auto;
            box-shadow: -3px 0 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }

        .sidebar.active {
            width: 250px;
            padding: 20px 15px;
        }

        .sidebar h2 {
            font-size: 1.6rem;
            margin-bottom: 30px;
            text-align: center;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .sidebar a {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            padding: 12px 15px;
            margin: 8px 0;
            border-radius: 8px;
            transition: all 0.3s ease;
            background-color: rgba(255, 255, 255, 0.1);
        }

        .sidebar a:hover {
            background-color: rgba(255, 255, 255, 0.3);
            transform: translateX(-5px);
        }

        .sidebar a i {
            margin-left: 12px;
            font-size: 1.2rem;
        }

        .content {
            margin-right: 0;
            margin-left: 0;
            padding: 20px;
            height: 100vh;
            overflow-y: auto;
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            width: 100%;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }

        .content.sidebar-active {
            margin-right: 250px;
            width: calc(100% - 250px);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .card {
            background-color: #fff;
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
            width: 100%;
            overflow-x: auto;
        }

        .card h3 {
            color: #0288d1;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .form-group label {
            font-weight: 500;
            color: #333;
        }

        .form-control,
        .form-select {
            border-radius: 5px;
        }

        .btn {
            border-radius: 5px;
            padding: 8px 20px;
            font-weight: 500;
        }

        .btn-primary {
            background-color: #0288d1;
            border-color: #0288d1;
        }

        .btn-primary:hover {
            background-color: #01579b;
            border-color: #01579b;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: #fff;
            border-radius: 5px;
            overflow: hidden;
            table-layout: auto;
        }

        th,
        td {
            border: 1px solid #dee2e6;
            padding: 12px;
            text-align: center;
            vertical-align: middle;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
            vertical-align: middle;
        }

        th {
            background-color: #0288d1;
            color: white;
            font-weight: 600;
        }

        .message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-weight: 500;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .notes-cell {
            position: relative;
        }

        .notes-icon {
            cursor: pointer;
            font-size: 1.2rem;
            color: #0288d1;
        }

        .notes-icon:hover {
            color: #01579b;
        }

        #searchBar {
            margin-bottom: 20px;
            width: 100%;
            max-width: 300px;
        }

        .update-info {
            font-size: 0.9rem;
            color: #333;
            background-color: #f8f9fa;
            padding: 5px 10px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            margin-bottom: 15px;
            text-align: right;
        }

        .patient-details-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            padding: 15px;
        }

        .patient-details-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .patient-details-section h6 {
            color: #0288d1;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .patient-details-section p {
            margin: 5px 0;
            font-size: 0.95rem;
            color: #333;
        }

        .room-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .room-icon {
            cursor: pointer;
            font-size: 1.1rem;
            color: #0288d1;
            transition: color 0.3s ease;
            padding: 4px;
            border-radius: 4px;
        }

        .room-icon:hover {
            color: #01579b;
            background-color: #e9ecef;
        }

        @media (max-width: 768px) {
            .sidebar.active {
                width: 70px;
                padding: 20px 10px;
            }

            .sidebar.active h2 {
                font-size: 1.2rem;
                margin-bottom: 20px;
            }

            .sidebar.active a {
                justify-content: center;
                padding: 12px 0;
            }

            .sidebar.active a span {
                display: none;
            }

            .sidebar.active a i {
                margin-left: 0;
                font-size: 1.4rem;
            }

            .content.sidebar-active {
                margin-right: 70px;
                width: calc(100% - 70px);
            }

            .patient-details-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .sidebar {
                width: 0;
                padding: 0;
                overflow: hidden;
            }

            .sidebar.active {
                width: 200px;
                padding: 20px 15px;
            }

            .content.sidebar-active {
                margin-right: 200px;
                width: calc(100% - 200px);
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
</head>

<body>
    <button id="toggleSidebar" class="btn btn-primary"
        style="position: fixed; top: 10px; right: 10px; z-index: 1100;">☰</button>
    <div class="sidebar">
        <h2>واجهة الممرض</h2>
        <a href="#" onclick="showSection('manage-patients')"><i class="bi bi-person-check"></i> <span>إدارة
                المرضى</span></a>
        <a href="#" onclick="showSection('all-patients')"><i class="bi bi-people"></i> <span>جميع المرضى</span></a>
        <a href="#" onclick="logout()"><i class="bi bi-box-arrow-right"></i> <span>تسجيل الخروج</span></a>
    </div>
    <div class="content">
        <h1 class="text-center mb-4" style="color: #0288d1;">واجهة الممرض</h1>

        <!-- Manage Patients Section -->
        <div id="manage-patients" class="section active">
            <div class="card">
                <h3>إدارة المرضى</h3>
                <div id="patientMessage" class="message"></div>
                <div class="input-group mb-3" style="max-width: 300px;">
                    <input type="text" class="form-control" id="searchBar"
                        placeholder="ابحث باسم المريض أو رقم التعريف">
                    <button class="btn btn-primary" onclick="searchPatients('manage-patients')">بحث</button>
                </div>
                <table id="managePatientsTable" class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>الاسم و اللقب</th>
                            <th>رقم الغرفة</th>
                            <th>الجنس</th>
                            <th>الحالة</th>
                            <th>التوصيات الطبية</th>
                            <th>تفاصيل حول المريض</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- All Patients Section -->
        <div id="all-patients" class="section">
            <div class="card">
                <h3>جميع المرضى</h3>
                <div id="allPatientsMessage" class="message"></div>
                <div class="input-group mb-3" style="max-width: 300px;">
                    <input type="text" class="form-control" id="searchBarAll"
                        placeholder="ابحث باسم المريض أو رقم التعريف">
                    <button class="btn btn-primary" onclick="searchPatients('all-patients')">بحث</button>
                </div>
                <table id="allPatientsTable" class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>الاسم واللقب</th>
                            <th>اللقب</th>
                            <th>رقم الغرفة</th>
                            <th>الجنس</th>
                            <th>الحالة</th>
                            <th>الحالة النشطة</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>


    <!-- Update Patient Modal -->
    <div class="modal fade" id="updatePatientModal" tabindex="-1" aria-labelledby="updatePatientModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="updatePatientModalLabel">تحديث بيانات المريض</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="updatePatientForm" class="row g-3">
                        <!-- Status -->
                        <div class="col-md-6">
                            <label for="updateStatus">الحالة</label>
                            <select class="form-select" id="updateStatus" name="etat_santee" required>
                                <option value="">اختر الحالة</option>
                                <option value="حالة مستقرة">حالة مستقرة</option>
                                <option value="حالة حرجة">حالة حرجة</option>
                                <option value="حالة خطيرة">حالة خطيرة</option>
                                <option value="حالة غير مستقرة">حالة غير مستقرة</option>
                                <option value="حالة وفاة سريرية">حالة وفاة سريرية</option>
                                <option value="حالة وفاة">حالة وفاة</option>
                            </select>
                        </div>
                    
                        <!-- Prescription: medication, dosage, frequency, instruction -->
                        <div class="col-md-12">
                            <label>الأدوية</label>
                            <div id="prescriptions">
                                <div class="input-group mb-2 prescription-item">
                                    <input type="text" class="form-control" placeholder="الدواء" name="medicament[]">
                                    <input type="text" class="form-control" placeholder="الجرعة" name="dosage[]">
                                    <input type="text" class="form-control" placeholder="التردد" name="frequency[]">
                                    <input type="text" class="form-control" placeholder="تعليمات" name="instruction[]">
                                    <button type="button" class="btn btn-outline-danger" onclick="removePrescription(this)">حذف</button>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-primary mt-2" onclick="addPrescription()">إضافة دواء</button>
                        </div>
                    
                        <!-- Diagnosis -->
                        <div class="col-md-12">
                            <label for="updateDiagnosis">التشخيص</label>
                            <textarea class="form-control" id="updateDiagnosis" name="diagnosis" rows="3" placeholder="أدخل التشخيص هنا" required></textarea>
                        </div>
                    
                        <!-- Treatment Method -->
                        <div class="col-md-12">
                            <label for="updateTreatmentMethod">طريقة العلاج</label>
                            <textarea class="form-control" id="updateTreatmentMethod" name="treatment_method" rows="3" placeholder="أدخل طريقة العلاج هنا" required></textarea>
                        </div>
                    
                        <!-- Suivi / Vital Signs -->
                        <div class="col-md-6">
                            <label for="updateTension">ضغط الدم (mmHg)</label>
                            <input type="text" class="form-control" id="updateTension" name="tension" placeholder="مثال: 120/80">
                        </div>
                        <div class="col-md-6">
                            <label for="updateTemperature">درجة الحرارة (°C)</label>
                            <input type="number" step="0.1" class="form-control" id="updateTemperature" name="temperature" placeholder="مثال: 36.5">
                        </div>
                        <div class="col-md-6">
                            <label for="updateFrequenceCardiaque">معدل ضربات القلب (نبضة/دقيقة)</label>
                            <input type="number" class="form-control" id="updateFrequenceCardiaque" name="frequence_quardiaque" placeholder="مثال: 80">
                        </div>
                        <div class="col-md-6">
                            <label for="updateSaturationOxygene">نسبة الأكسجين في الدم (%)</label>
                            <input type="number" class="form-control" id="updateSaturationOxygene" name="saturation_oxygene" placeholder="مثال: 98">
                        </div>
                        <div class="col-md-6">
                            <label for="updateGlycemie">مستوى الجلوكوز في الدم (mg/dL)</label>
                            <input type="number" step="0.1" class="form-control" id="updateGlycemie" name="glycemie" placeholder="مثال: 90">
                        </div>
                        <div class="col-md-12">
                            <label for="updateRemarque">ملاحظات</label>
                            <textarea class="form-control" id="updateRemarque" name="Remarque" rows="3" placeholder="أدخل ملاحظات إضافية"></textarea>
                        </div>
                    
                        <!-- Date of Observation -->
                        <div class="col-md-6">
                            <label for="updateDateObservation">تاريخ الملاحظة</label>
                            <input type="datetime-local" class="form-control" id="updateDateObservation" name="Date_observation">
                        </div>
                    </form>
                    
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                    <button type="button" class="btn btn-primary" id="updateButton">تحديث</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Select Room Modal for Add -->
    <div class="modal fade" id="selectRoomModalAdd" tabindex="-1" aria-labelledby="selectRoomModalAddLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="selectRoomModalAddLabel">اختر غرفة</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="availableRoomsAdd" class="row"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- View Recommendations Modal -->
    <div class="modal fade" id="viewRecommendationsModal" tabindex="-1" aria-labelledby="viewRecommendationsModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="viewRecommendationsModalLabel">التوصيات الطبية</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="viewRecommendationsContent"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Patient Details Modal -->
    <div class="modal fade" id="viewPatientDetailsModal" tabindex="-1" aria-labelledby="viewPatientDetailsModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="viewPatientDetailsModalLabel">تفاصيل المريض</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="viewPatientDetailsContent"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // DOM Elements
const patientMessage = document.getElementById('patientMessage');
const allPatientsMessage = document.getElementById('allPatientsMessage');
const managePatientsTable = document.getElementById('managePatientsTable').getElementsByTagName('tbody')[0];
const allPatientsTable = document.getElementById('allPatientsTable').getElementsByTagName('tbody')[0];
const updateButton = document.getElementById('updateButton');
const updatePatientModal = document.getElementById('updatePatientModal');
const viewRecommendationsModal = document.getElementById('viewRecommendationsModal');
const selectRoomModalAdd = document.getElementById('selectRoomModalAdd');
const sidebar = document.querySelector('.sidebar');
const toggleSidebarBtn = document.getElementById('toggleSidebar');
const content = document.querySelector('.content');

// Global Variables
let selectedPatientId = null;
let selectedSejourId = null;
let isAddMode = false;

// Utility Functions
function showMessage(text, type) {
    if (patientMessage) {
        patientMessage.textContent = text;
        patientMessage.className = `message ${type}`;
        patientMessage.style.display = 'block';
        setTimeout(() => patientMessage.style.display = 'none', 3000);
    }
}

function showMessageAll(text, type) {
    if (allPatientsMessage) {
        allPatientsMessage.textContent = text;
        allPatientsMessage.className = `message ${type}`;
        allPatientsMessage.style.display = 'block';
        setTimeout(() => allPatientsMessage.style.display = 'none', 3000);
    }
}

// Prescription Management
function addPrescription() {
    const container = document.getElementById('prescriptions');
    if (!container) return;
    
    const div = document.createElement('div');
    div.classList.add('input-group', 'mb-2', 'prescription-item');
    div.innerHTML = `
        <input type="text" class="form-control" placeholder="الدواء" name="medicament[]">
        <input type="text" class="form-control" placeholder="الجرعة" name="dosage[]">
        <input type="text" class="form-control" placeholder="التردد" name="frequency[]">
        <input type="text" class="form-control" placeholder="تعليمات" name="instruction[]">
        <button type="button" class="btn btn-outline-danger" onclick="removePrescription(this)">حذف</button>
    `;
    container.appendChild(div);
}

function removePrescription(button) {
    if (button && button.parentElement) {
        button.parentElement.remove();
    }
}

// Room Management
function openRoomSelection(sejourId = null) {
    selectedSejourId = sejourId;
    const nurse = JSON.parse(localStorage.getItem('loggedInUser'));
    if (nurse && nurse.id) {
        loadAvailableRooms(nurse.id);
    } else {
        showMessage('خطأ في بيانات المستخدم', 'error');
    }
}

async function loadAvailableRooms(nurse_id) {
    try {
        const response = await axios.get('/nurse/room', {
            params: { nurse_id: nurse_id }
        });

        const rooms = response.data;
        const container = document.getElementById('availableRoomsAdd');
        if (!container) return;

        container.innerHTML = '';

        if (!Array.isArray(rooms) || rooms.length === 0) {
            container.innerHTML = '<p class="text-center">لا توجد غرف متاحة</p>';
            return;
        }

        rooms.forEach(room => {
            const roomBtn = document.createElement('button');
            roomBtn.className = 'btn btn-outline-primary m-1';
            roomBtn.textContent = room.numero_cr || room.room_number || 'غير محدد';
            roomBtn.onclick = () => selectRoom(room);
            container.appendChild(roomBtn);
        });

    } catch (error) {
        console.error('Error loading rooms:', error);
        showMessage('حدث خطأ أثناء تحميل الغرف', 'error');
    }
}

function selectRoom(room) {
    if (!selectedSejourId) {
        showMessage('خطأ في تحديد الإقامة', 'error');
        return;
    }

    const nurse = JSON.parse(localStorage.getItem('loggedInUser'));
    if (!nurse || !nurse.id) {
        showMessage('خطأ في بيانات المستخدم', 'error');
        return;
    }

    // Update room assignment
    axios.put('/sejour/room', {
        id_sejour: selectedSejourId,
        id_chambre: room.id_chambre || room.room_id,
        id_agent: nurse.id
    })
    .then(response => {
        if (response.status === 200) {
            loadManagePatients();
            showMessage('تم تحديث رقم الغرفة بنجاح', 'success');
        } else {
            showMessage('فشل في تحديث الغرفة', 'error');
        }
    })
    .catch(error => {
        console.error('Error updating room:', error);
        showMessage('حدث خطأ أثناء التحديث', 'error');
    })
    .finally(() => {
        const modal = bootstrap.Modal.getInstance(selectRoomModalAdd);
        if (modal) modal.hide();
    });
}

// Patient Data Loading
async function loadManagePatients() {
    try {
        const nurse = JSON.parse(localStorage.getItem('loggedInUser'));
        if (!nurse || !nurse.id) {
            showMessage('خطأ في بيانات المستخدم', 'error');
            return;
        }

        const response = await axios.get(`/nurse/patients?nurse_id=${nurse.id}`);
        
        const patientsData = response.data.data || response.data;
        const patients = Array.isArray(patientsData) ? patientsData : [];
        
        console.log("Manage Patients Data:", patients);
        displayPatients(managePatientsTable, patients, true);

    } catch (error) {
        console.error('Error loading patients:', error);
        showMessage('حدث خطأ أثناء تحميل المرضى', 'error');
    }
}

async function loadAllPatients() {
    try {
        const nurse = JSON.parse(localStorage.getItem('loggedInUser'));
        if (!nurse || !nurse.id) {
            showMessageAll('خطأ في بيانات المستخدم', 'error');
            return;
        }

        const response = await axios.get(`/nurse/patients?nurse_id=${nurse.id}`);
        
        const patientsData = response.data.data || response.data;
        const patients = Array.isArray(patientsData) ? patientsData : [];
        
        console.log("All Patients Data:", patients);
        displayPatients(allPatientsTable, patients, false);
        
    } catch (error) {
        console.error('Error loading patients:', error);
        showMessageAll('حدث خطأ أثناء تحميل المرضى', 'error');
    }
}

function displayPatients(table, patientsList, isManageSection) {
    if (!table) return;

    console.log("displayPatients received:", patientsList);
    table.innerHTML = '';

    if (!Array.isArray(patientsList) || patientsList.length === 0) {
        const row = table.insertRow();
        const cell = row.insertCell();
        cell.colSpan = isManageSection ? 7 : 7;
        cell.textContent = 'لا توجد بيانات للعرض';
        cell.style.textAlign = 'center';
        return;
    }

    patientsList.forEach(patient => {
        const row = table.insertRow();

        const isActive = (patient.Date_sortie || patient.Date_sortiee) ? 'غير نشط' : 'نشط';
        const patientName = patient.full_name || `${patient.Nom || ''} ${patient.Prénom || ''}`.trim() || '-';
        const roomNumber = patient.Numero_cr || patient.Numéro_CR || '-';
        const patientId = patient.id_patient || patient.patient_id;
        const sejourId = patient.id_séjour || patient.id_sejour || patient.sejour_id;

        if (isManageSection) {
            // Manage Patients section
            row.innerHTML = `
                <td>${patientName}</td>
                <td class="room-cell">
                    ${roomNumber}
                    <i class="bi bi-pencil-square room-icon"
                       onclick="openRoomSelection(${sejourId})"
                       title="تغيير الغرفة"></i>
                </td>
                <td>${patient.sex || patient.Gender || '-'}</td>
                <td>${isActive}</td>
                <td class="notes-cell">
                    <i class="bi bi-eye notes-icon"
                       onclick="viewRecommendations(${sejourId})"
                       title="عرض التوصيات"
                       data-bs-toggle="modal"
                       data-bs-target="#viewRecommendationsModal"></i>
                </td>
                <td>
                    <i class="bi bi-eye notes-icon"
                       onclick="viewPatientDetails(${patientId})"
                       title="عرض التفاصيل"
                       data-bs-toggle="modal"
                       data-bs-target="#viewPatientDetailsModal"></i>
                </td>
                <td>
                    <button class="btn btn-primary btn-sm"
                            onclick="openUpdateModal(${patientId}, ${sejourId})"
                            data-bs-toggle="modal"
                            data-bs-target="#updatePatientModal">
                        تحديث
                    </button>
                </td>
            `;
        } else {
            // All Patients section
            row.innerHTML = `
                <td>${patientName}</td>
                <td>${patient.NIN || '-'}</td>
                <td>${roomNumber}</td>
                <td>${patient.sex || patient.Gender || '-'}</td>
                <td>${patient.nom_service || patient.Nom_S || '-'}</td>
                <td>${isActive}</td>
                <td>
                    ${(patient.Date_sortie || patient.Date_sortiee)
                        ? '<span class="text-muted">تم الخروج</span>'
                        : `<button class="btn btn-warning btn-sm"
                                   onclick="togglePatientStatus(${sejourId})">
                               إنهاء الإقامة
                           </button>`
                    }
                </td>
            `;
        }
    });
}

// Modal Functions
function openUpdateModal(patientId, sejourId) {
    selectedPatientId = patientId;
    selectedSejourId = sejourId;
    
    // Clear previous form data
    const form = document.getElementById('updatePatientForm');
    if (form) {
        form.reset();
    }
    
    // Reset prescriptions to default state
    const prescriptionsContainer = document.getElementById('prescriptions');
    if (prescriptionsContainer) {
        prescriptionsContainer.innerHTML = `
            <div class="input-group mb-2 prescription-item">
                <input type="text" class="form-control" placeholder="الدواء" name="medicament[]">
                <input type="text" class="form-control" placeholder="الجرعة" name="dosage[]">
                <input type="text" class="form-control" placeholder="التردد" name="frequency[]">
                <input type="text" class="form-control" placeholder="تعليمات" name="instruction[]">
                <button type="button" class="btn btn-outline-danger" onclick="removePrescription(this)">حذف</button>
            </div>
        `;
    }

    // Set current date-time for observation
    const dateObservation = document.getElementById('updateDateObservation');
    if (dateObservation) {
        const now = new Date();
        const localDateTime = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
        dateObservation.value = localDateTime;
    }
}

async function saveUpdatedPatient() {
    try {
        if (!selectedSejourId) {
            throw new Error('لم يتم تحديد الإقامة');
        }

        const nurse = JSON.parse(localStorage.getItem('loggedInUser'));
        if (!nurse || !nurse.id) {
            throw new Error('خطأ في بيانات المستخدم');
        }

        // Collect prescriptions
        const prescriptions = [];
        const prescriptionItems = document.querySelectorAll('#prescriptions .prescription-item');
        prescriptionItems.forEach(item => {
            const medicament = item.querySelector('input[name="medicament[]"]')?.value?.trim();
            const dosage = item.querySelector('input[name="dosage[]"]')?.value?.trim();
            const frequency = item.querySelector('input[name="frequency[]"]')?.value?.trim();
            const instruction = item.querySelector('input[name="instruction[]"]')?.value?.trim();
            
            if (medicament || dosage || frequency || instruction) {
                prescriptions.push({ medicament, dosage, frequency, instruction });
            }
        });

        // Collect form data
        const status = document.getElementById('updateStatus')?.value;
        const diagnosis = document.getElementById('updateDiagnosis')?.value?.trim();
        const treatmentMethod = document.getElementById('updateTreatmentMethod')?.value?.trim();
        const tension = document.getElementById('updateTension')?.value?.trim();
        const temperature = parseFloat(document.getElementById('updateTemperature')?.value) || null;
        const frequenceCardiaque = parseInt(document.getElementById('updateFrequenceCardiaque')?.value) || null;
        const saturationOxygene = parseInt(document.getElementById('updateSaturationOxygene')?.value) || null;
        const glycemie = parseFloat(document.getElementById('updateGlycemie')?.value) || null;
        const remarque = document.getElementById('updateRemarque')?.value?.trim();
        const dateObservation = document.getElementById('updateDateObservation')?.value;

        if (!status) {
            throw new Error('يرجى تحديد حالة المريض');
        }

        // Update prescriptions
        if (prescriptions.length > 0) {
            try {
                // Delete existing prescriptions
                const existingPrescriptionsResponse = await axios.get('/prescriptions', {
                    params: { id_sejour: selectedSejourId }
                });

                if (existingPrescriptionsResponse.status === 200 && existingPrescriptionsResponse.data.prescriptions) {
                    const existingPrescriptions = existingPrescriptionsResponse.data.prescriptions;
                    
                    for (const prescription of existingPrescriptions) {
                        await axios.delete('/prescription', {
                            params: { id: prescription.id_prescription }
                        });
                    }
                }

                // Add new prescriptions
                for (const prescription of prescriptions) {
                    await axios.post('/prescription', {
                        id_sejour: selectedSejourId,
                        Medicament: prescription.medicament || '',
                        Dosage: prescription.dosage || '',
                        frequence: prescription.frequency || '',
                        instructions: prescription.instruction || ''
                    });
                }
            } catch (prescriptionError) {
                console.error('Prescription update error:', prescriptionError);
                // Continue with suivi creation even if prescription update fails
            }
        }

        // Create suivi record
        const suiviData = {
            Date_observation: dateObservation || new Date().toISOString().split('T')[0],
            id_sejour: selectedSejourId,
            id_nurse: nurse.id,
            etat_santee: status,
            tension: tension || null,
            temperature: temperature,
            frequence_quardiaque: frequenceCardiaque,
            saturation_oxygene: saturationOxygene,
            glycemie: glycemie,
            Remarque: remarque || null
        };

        const suiviResponse = await axios.post('/suivis', suiviData);

        if (suiviResponse.status === 200 || suiviResponse.status === 201) {
            // Reload patient data
            await loadManagePatients();
            await loadAllPatients();
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(updatePatientModal);
            if (modal) modal.hide();
            
            showMessage('تم تحديث بيانات المريض بنجاح', 'success');
        } else {
            throw new Error('فشل في حفظ بيانات المتابعة');
        }

    } catch (error) {
        console.error('Error saving patient data:', error);
        showMessage(error.message || 'حدث خطأ أثناء التحديث', 'error');
    }
}

async function togglePatientStatus(sejourId) {
    if (!sejourId) {
        showMessageAll('خطأ في تحديد الإقامة', 'error');
        return;
    }

    try {
        const response = await axios.put('/sejour/status', {
            id_sejour: sejourId,
            Date_sortie: new Date().toISOString().split('T')[0]
        });

        if (response.status === 200) {
            await loadManagePatients();
            await loadAllPatients();
            showMessageAll('تم إنهاء إقامة المريض بنجاح', 'success');
        } else {
            throw new Error('فشل في تحديث حالة المريض');
        }
    } catch (error) {
        console.error('Error toggling patient status:', error);
        showMessageAll('حدث خطأ أثناء تغيير حالة المريض', 'error');
    }
}

async function viewRecommendations(sejourId) {
    try {
        if (!sejourId) {
            throw new Error('لم يتم تحديد الإقامة');
        }

        // Get prescriptions for this sejour
        const prescriptionsResponse = await axios.get('/prescription', {
            params: { id_sejour: sejourId }
        });

        const prescriptions = prescriptionsResponse.data;
        console.log(prescriptionsResponse);
        
        // Get sejour details if available
        let sejourDetails = {};
        try {
            const sejourResponse = await axios.get('/patient/detail', {
                params: { id: sejourId }
            });
            sejourDetails = sejourResponse.data || {};
        } catch (sejourError) {
            console.warn('Could not load sejour details:', sejourError);
        }

        const content = document.getElementById('viewRecommendationsContent');
        if (!content) return;

        content.innerHTML = `
            <div class="update-info">
                <strong>آخر تحديث:</strong> ${sejourDetails.Updated_at ? new Date(sejourDetails.Updated_at).toLocaleString('ar-SA') : '-'}<br>
                <strong>بواسطة:</strong> ${sejourDetails.nurse_name || '-'}
            </div>
            <h5>الإجراءات المعمول بها:</h5>
            <h6>الأدوية:</h6>
            <div class="prescription-list">
                ${prescriptions.length > 0
                    ? prescriptions.map(p => `
                        <div class="prescription-item mb-2 p-2 border rounded">
                            <strong>الدواء:</strong> ${p.Medicament || p.medicament || '-'}<br>
                            <strong>الجرعة:</strong> ${p.Dosage || p.dosage || '-'}<br>
                            <strong>التردد:</strong> ${p.frequence || p.frequency || '-'}<br>
                            <strong>التعليمات:</strong> ${p.instructions || p.instruction || '-'}
                        </div>
                    `).join('')
                    : '<p>لا توجد أدوية محددة</p>'
                }
            </div>
            <h6>التشخيص:</h6>
            <p>${sejourDetails.Diagnosis || '-'}</p>
            <h6>طريقة العلاج:</h6>
            <p>${sejourDetails.Treatment_method || '-'}</p>
        `;

        const modalTitle = document.getElementById('viewRecommendationsModalLabel');
        if (modalTitle) {
            modalTitle.textContent = `التوصيات الطبية ${sejourDetails.patient_name ? 'لـ ' + sejourDetails.patient_name : ''}`;
        }

    } catch (error) {
        console.error('Error loading recommendations:', error);
        showMessage('حدث خطأ أثناء تحميل التوصيات', 'error');
    }
}

async function viewPatientDetails(patientId) {
    try {
        if (!patientId) {
            throw new Error('لم يتم تحديد المريض');
        }

        const response = await axios.get('/patient/detail', {
            params: { id: patientId }
        });
        
        const patientData = response.data;
        console.log('Patient details response:', patientData);

        const patient = Array.isArray(patientData) ? patientData[0] : patientData;
        
        if (!patient) {
            throw new Error('لم يتم العثور على بيانات المريض');
        }

        const content = document.getElementById('viewPatientDetailsContent');
        if (!content) return;

        content.innerHTML = `
            <div class="patient-details-container">
                <div class="patient-details-section">
                    <h6>المعلومات الشخصية</h6>
                    <p><strong>الاسم الكامل:</strong> ${patient.full_name || `${patient.Nom || ''} ${patient.Prénom || ''}`.trim() || '-'}</p>
                    <p><strong>رقم التعريف:</strong> ${patient.NIN || '-'}</p>
                    <p><strong>رقم الهاتف:</strong> ${patient.telephone || patient.Tel || '-'}</p>
                    <p><strong>الجنس:</strong> ${patient.sex || patient.Gender || '-'}</p>
                    <p><strong>العمر:</strong> ${patient.age || '-'}</p>
                    <p><strong>زمرة الدم:</strong> ${patient.groupage || patient.Blood_type || '-'}</p>
                    <p><strong>العنوان:</strong> ${patient.adress || patient.address || '-'}</p>
                </div>
                <div class="patient-details-section">
                    <h6>البيانات الحيوية الأخيرة</h6>
                    <p><strong>درجة الحرارة:</strong> ${patient.Température || patient.temperature ? (patient.Température || patient.temperature) + ' °C' : '-'}</p>
                    <p><strong>معدل ضربات القلب:</strong> ${patient.Fréquence_cardiaque || patient.heart_rate ? (patient.Fréquence_cardiaque || patient.heart_rate) + ' نبضة/دقيقة' : '-'}</p>
                    <p><strong>ضغط الدم:</strong> ${patient.Tension_artérielle || patient.blood_pressure || '-'}</p>
                    <p><strong>نسبة الأكسجين:</strong> ${patient.Saturation_oxygène || patient.oxygen_saturation ? (patient.Saturation_oxygène || patient.oxygen_saturation) + '%' : '-'}</p>
                    <p><strong>مستوى الجلوكوز:</strong> ${patient.glycemie || patient.glucose_level ? (patient.glycemie || patient.glucose_level) + ' mg/dL' : '-'}</p>
                    <p><strong>الوزن:</strong> ${patient.Poids || patient.weight ? (patient.Poids || patient.weight) + ' كجم' : '-'}</p>
                    <p><strong>الطول:</strong> ${patient.Taille || patient.height ? (patient.Taille || patient.height) + ' سم' : '-'}</p>
                </div>
            </div>
        `;
        
        const modalTitle = document.getElementById('viewPatientDetailsModalLabel');
        if (modalTitle) {
            modalTitle.textContent = `تفاصيل المريض: ${patient.full_name || `${patient.Nom || ''} ${patient.Prénom || ''}`.trim() || 'غير محدد'}`;
        }

    } catch (error) {
        console.error('Error loading patient details:', error);
        showMessage('حدث خطأ أثناء تحميل تفاصيل المريض', 'error');
    }
}

// Search Function
async function searchPatients(sectionId) {
    try {
        const searchTerm = sectionId === 'manage-patients' ? 
            document.getElementById('searchBar')?.value?.trim()?.toLowerCase() : 
            document.getElementById('searchBarAll')?.value?.trim()?.toLowerCase();
        
        if (!searchTerm) {
            // If search is empty, reload all patients
            if (sectionId === 'manage-patients') {
                await loadManagePatients();
            } else {
                await loadAllPatients();
            }
            return;
        }

        const nurse = JSON.parse(localStorage.getItem('loggedInUser'));
        if (!nurse || !nurse.id) {
            throw new Error('خطأ في بيانات المستخدم');
        }

        const response = await axios.get('/nurse/patients/search', {
            params: { 
                nurse_id: nurse.id,
                search: searchTerm 
            }
        });

        const patients = Array.isArray(response.data) ? response.data : (response.data.data || []);
        
        if (sectionId === 'manage-patients') {
            const activePatients = patients.filter(p => !p.Date_sortiee && !p.Date_sortie);
            displayPatients(managePatientsTable, activePatients, true);
        } else {
            displayPatients(allPatientsTable, patients, false);
        }

    } catch (error) {
        console.error('Error searching patients:', error);
        const errorMessage = 'حدث خطأ أثناء البحث';
        if (sectionId === 'manage-patients') {
            showMessage(errorMessage, 'error');
        } else {
            showMessageAll(errorMessage, 'error');
        }
    }
}

// Navigation Functions
function logout() {
    localStorage.removeItem('loggedInUser');
    window.location.href = '/';
}

function showSection(sectionId) {
    // Hide all sections
    document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
    });
    
    // Show selected section
    const selectedSection = document.getElementById(sectionId);
    if (selectedSection) {
        selectedSection.classList.add('active');
    }
    
    // Load data for the section
    if (sectionId === 'manage-patients') {
        loadManagePatients();
    } else if (sectionId === 'all-patients') {
        loadAllPatients();
    }
}

// Event Listeners
document.addEventListener('DOMContentLoaded', function() {
    // Sidebar toggle
    if (toggleSidebarBtn) {
        toggleSidebarBtn.addEventListener('click', () => {
            sidebar?.classList.toggle('active');
            content?.classList.toggle('sidebar-active');
        });
    }

    // Update button
    if (updateButton) {
        updateButton.addEventListener('click', saveUpdatedPatient);
    }

    // Search bars
    const searchBar = document.getElementById('searchBar');
    if (searchBar) {
        searchBar.addEventListener('input', () => searchPatients('manage-patients'));
    }

    const searchBarAll = document.getElementById('searchBarAll');
    if (searchBarAll) {
        searchBarAll.addEventListener('input', () => searchPatients('all-patients'));
    }

    // Initialize page
    loadManagePatients();
    loadAllPatients();
});

// Handle page visibility changes
document.addEventListener('visibilitychange', function() {
    if (!document.hidden) {
        // Refresh data when page becomes visible
        loadManagePatients();
        loadAllPatients();
    }
});
</script>

</body>

</html>