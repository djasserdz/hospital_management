<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>واجهة الممرض</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <style>
        body {
            font-family: 'Tajawal', 'Segoe UI', Tahoma, Arial, sans-serif;
            background-color: #f8f9fa;
            direction: rtl;
            text-align: right;
            height: 100vh;
            overflow: hidden;
            margin: 0;
        }

        .sidebar {
            width: 0;
            background: linear-gradient(180deg, #0288d1, #01579b);
            color: white;
            height: 100vh;
            position: fixed;
            top: 0;
            right: 0;
            padding: 0;
            transition: all 0.3s ease;
            overflow-y: auto;
            box-shadow: -3px 0 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }

        .sidebar.active {
            width: 250px;
            padding: 20px 15px;
        }

        .sidebar h2 {
            font-size: 1.6rem;
            margin-bottom: 30px;
            text-align: center;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .sidebar a {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            padding: 12px 15px;
            margin: 8px 0;
            border-radius: 8px;
            transition: all 0.3s ease;
            background-color: rgba(255, 255, 255, 0.1);
        }

        .sidebar a:hover {
            background-color: rgba(255, 255, 255, 0.3);
            transform: translateX(-5px);
        }

        .sidebar a i {
            margin-left: 12px;
            font-size: 1.2rem;
        }

        .content {
            margin-right: 0;
            margin-left: 0;
            padding: 20px;
            height: 100vh;
            overflow-y: auto;
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            width: 100%;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }

        .content.sidebar-active {
            margin-right: 250px;
            width: calc(100% - 250px);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .card {
            background-color: #fff;
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
            width: 100%;
            overflow-x: auto;
        }

        .card h3 {
            color: #0288d1;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .form-group label {
            font-weight: 500;
            color: #333;
        }

        .form-control,
        .form-select {
            border-radius: 5px;
        }

        .btn {
            border-radius: 5px;
            padding: 8px 20px;
            font-weight: 500;
        }

        .btn-primary {
            background-color: #0288d1;
            border-color: #0288d1;
        }

        .btn-primary:hover {
            background-color: #01579b;
            border-color: #01579b;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: #fff;
            border-radius: 5px;
            overflow: hidden;
            table-layout: auto;
        }

        th,
        td {
            border: 1px solid #dee2e6;
            padding: 12px;
            text-align: center;
            vertical-align: middle;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
            vertical-align: middle;
        }

        th {
            background-color: #0288d1;
            color: white;
            font-weight: 600;
        }

        .message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-weight: 500;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .notes-cell {
            position: relative;
        }

        .notes-icon {
            cursor: pointer;
            font-size: 1.2rem;
            color: #0288d1;
        }

        .notes-icon:hover {
            color: #01579b;
        }

        #searchBar {
            margin-bottom: 20px;
            width: 100%;
            max-width: 300px;
        }

        .update-info {
            font-size: 0.9rem;
            color: #333;
            background-color: #f8f9fa;
            padding: 5px 10px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            margin-bottom: 15px;
            text-align: right;
        }

        .patient-details-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            padding: 15px;
        }

        .patient-details-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .patient-details-section h6 {
            color: #0288d1;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .patient-details-section p {
            margin: 5px 0;
            font-size: 0.95rem;
            color: #333;
        }

        .room-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .room-icon {
            cursor: pointer;
            font-size: 1.1rem;
            color: #0288d1;
            transition: color 0.3s ease;
            padding: 4px;
            border-radius: 4px;
        }

        .room-icon:hover {
            color: #01579b;
            background-color: #e9ecef;
        }

        @media (max-width: 768px) {
            .sidebar.active {
                width: 70px;
                padding: 20px 10px;
            }

            .sidebar.active h2 {
                font-size: 1.2rem;
                margin-bottom: 20px;
            }

            .sidebar.active a {
                justify-content: center;
                padding: 12px 0;
            }

            .sidebar.active a span {
                display: none;
            }

            .sidebar.active a i {
                margin-left: 0;
                font-size: 1.4rem;
            }

            .content.sidebar-active {
                margin-right: 70px;
                width: calc(100% - 70px);
            }

            .patient-details-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .sidebar {
                width: 0;
                padding: 0;
                overflow: hidden;
            }

            .sidebar.active {
                width: 200px;
                padding: 20px 15px;
            }

            .content.sidebar-active {
                margin-right: 200px;
                width: calc(100% - 200px);
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
</head>

<body>
    <button id="toggleSidebar" class="btn btn-primary"
        style="position: fixed; top: 10px; right: 10px; z-index: 1100;">☰</button>
    <div class="sidebar">
        <h2>واجهة الممرض</h2>
        <a href="#" onclick="showSection('manage-patients')"><i class="bi bi-person-check"></i> <span>إدارة
                المرضى</span></a>
        <a href="#" onclick="showSection('all-patients')"><i class="bi bi-people"></i> <span>جميع المرضى</span></a>
        <a href="#" onclick="logout()"><i class="bi bi-box-arrow-right"></i> <span>تسجيل الخروج</span></a>
    </div>
    <div class="content">
        <h1 class="text-center mb-4" style="color: #0288d1;">واجهة الممرض</h1>

        <!-- Manage Patients Section -->
        <div id="manage-patients" class="section active">
            <div class="card">
                <h3>إدارة المرضى</h3>
                <div id="patientMessage" class="message"></div>
                <div class="input-group mb-3" style="max-width: 300px;">
                    <input type="text" class="form-control" id="searchBar"
                        placeholder="ابحث باسم المريض أو رقم التعريف">
                    <button class="btn btn-primary" onclick="searchPatients('manage-patients')">بحث</button>
                </div>
                <table id="managePatientsTable" class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>الاسم</th>
                            <th>اللقب</th>
                            <th>رقم الغرفة</th>
                            <th>الجنس</th>
                            <th>الحالة</th>
                            <th>التوصيات الطبية</th>
                            <th>تفاصيل حول المريض</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- All Patients Section -->
        <div id="all-patients" class="section">
            <div class="card">
                <h3>جميع المرضى</h3>
                <div id="allPatientsMessage" class="message"></div>
                <div class="input-group mb-3" style="max-width: 300px;">
                    <input type="text" class="form-control" id="searchBarAll"
                        placeholder="ابحث باسم المريض أو رقم التعريف">
                    <button class="btn btn-primary" onclick="searchPatients('all-patients')">بحث</button>
                </div>
                <table id="allPatientsTable" class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>الاسم</th>
                            <th>اللقب</th>
                            <th>رقم الغرفة</th>
                            <th>الجنس</th>
                            <th>الحالة</th>
                            <th>الحالة النشطة</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>


    <!-- Update Patient Modal -->
    <div class="modal fade" id="updatePatientModal" tabindex="-1" aria-labelledby="updatePatientModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="updatePatientModalLabel">تحديث بيانات المريض</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="updatePatientForm" class="row g-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="updateStatus">الحالة</label>
                                <select class="form-select" id="updateStatus" name="status" required>
                                    <option value="">اختر الحالة</option>
                                    <option value="حالة مستقرة">حالة مستقرة</option>
                                    <option value="حالة حرجة">حالة حرجة</option>
                                    <option value="حالة خطيرة">حالة خطيرة</option>
                                    <option value="حالة غير مستقرة">حالة غير مستقرة</option>
                                    <option value="حالة وفاة سريرية">حالة وفاة سريرية</option>
                                    <option value="حالة وفاة">حالة وفاة</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="form-group">
                                <label>الأدوية</label>
                                <div id="recommendations">
                                    <div class="input-group mb-2 recommendation-item">
                                        <input type="text" class="form-control" placeholder="الدواء"
                                            name="medication[]">
                                        <input type="text" class="form-control" placeholder="الجرعة" name="dosage[]">
                                        <button type="button" class="btn btn-outline-danger"
                                            onclick="removeRecommendation(this)">حذف</button>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-outline-primary mt-2"
                                    onclick="addRecommendation('recommendations')">إضافة دواء</button>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="updateDiagnosis">التشخيص</label>
                                <textarea class="form-control" id="updateDiagnosis" name="diagnosis" rows="3"
                                    placeholder="أدخل التشخيص هنا" required></textarea>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="updateTreatmentMethod">طريقة العلاج</label>
                                <textarea class="form-control" id="updateTreatmentMethod" name="treatment_method"
                                    rows="3" placeholder="أدخل طريقة العلاج هنا" required></textarea>
                            </div>
                        </div>
                        <!-- البيانات الحيوية -->
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="updateTemperature">درجة الحرارة (°C)</label>
                                <input type="number" step="0.1" class="form-control" id="updateTemperature"
                                    name="temperature" placeholder="مثال: 36.5">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="updateHeartRate">معدل ضربات القلب (نبضة/دقيقة)</label>
                                <input type="number" class="form-control" id="updateHeartRate" name="heart_rate"
                                    placeholder="مثال: 80">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="updateRespiratoryRate">معدل التنفس (نفس/دقيقة)</label>
                                <input type="number" class="form-control" id="updateRespiratoryRate"
                                    name="respiratory_rate" placeholder="مثال: 16">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="updateBloodPressure">ضغط الدم (mmHg)</label>
                                <input type="text" class="form-control" id="updateBloodPressure" name="blood_pressure"
                                    placeholder="مثال: 120/80">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="updateOxygenSaturation">نسبة الأكسجين في الدم (%)</label>
                                <input type="number" class="form-control" id="updateOxygenSaturation"
                                    name="oxygen_saturation" placeholder="مثال: 98">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="updateWeight">الوزن (كجم)</label>
                                <input type="number" step="0.1" class="form-control" id="updateWeight" name="weight"
                                    placeholder="مثال: 70">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="updateHeight">الطول (سم)</label>
                                <input type="number" class="form-control" id="updateHeight" name="height"
                                    placeholder="مثال: 170">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                    <button type="button" class="btn btn-primary" id="updateButton">تحديث</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Select Room Modal for Add -->
    <div class="modal fade" id="selectRoomModalAdd" tabindex="-1" aria-labelledby="selectRoomModalAddLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="selectRoomModalAddLabel">اختر غرفة</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="availableRoomsAdd" class="row"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- View Recommendations Modal -->
    <div class="modal fade" id="viewRecommendationsModal" tabindex="-1" aria-labelledby="viewRecommendationsModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="viewRecommendationsModalLabel">التوصيات الطبية</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="viewRecommendationsContent"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Patient Details Modal -->
    <div class="modal fade" id="viewPatientDetailsModal" tabindex="-1" aria-labelledby="viewPatientDetailsModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="viewPatientDetailsModalLabel">تفاصيل المريض</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="viewPatientDetailsContent"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const patientMessage = document.getElementById('patientMessage');
        const allPatientsMessage = document.getElementById('allPatientsMessage');
        const managePatientsTable = document.getElementById('managePatientsTable').getElementsByTagName('tbody')[0];
        const allPatientsTable = document.getElementById('allPatientsTable').getElementsByTagName('tbody')[0];
        const addButton = document.getElementById('addButton');
        const updateButton = document.getElementById('updateButton');
        const addPatientModal = document.getElementById('addPatientModal');
        const updatePatientModal = document.getElementById('updatePatientModal');
        const viewRecommendationsModal = document.getElementById('viewRecommendationsModal');
        const selectRoomModalAdd = document.getElementById('selectRoomModalAdd');
        let selectedPatientId = null;
        let selectedSejourId = null;
        const sidebar = document.querySelector('.sidebar');
        const toggleSidebarBtn = document.getElementById('toggleSidebar');
        const content = document.querySelector('.content');

        function showMessage(text, type) {
            patientMessage.textContent = text;
            patientMessage.className = `message ${type}`;
            patientMessage.style.display = 'block';
            setTimeout(() => patientMessage.style.display = 'none', 3000);
        }

        function showMessageAll(text, type) {
            allPatientsMessage.textContent = text;
            allPatientsMessage.className = `message ${type}`;
            allPatientsMessage.style.display = 'block';
            setTimeout(() => allPatientsMessage.style.display = 'none', 3000);
        }

        async function loadAvailableRooms(isAddMode = false) {
            try {
                const response = await fetch('api/routes/chambres.php');
                const rooms = await response.json();
                const container = document.getElementById('availableRoomsAdd');
                container.innerHTML = '';
                rooms.forEach(room => {
                    const roomBtn = document.createElement('button');
                    roomBtn.className = 'btn btn-outline-primary m-1';
                    roomBtn.textContent = room.Numéro_CR;
                    roomBtn.onclick = () => {
                        if (isAddMode) {
                            document.getElementById('addRoom').value = room.Numéro_CR;
                            document.getElementById('addRoom').dataset.id_chambre = room.id_chambre;
                        } else {
                            fetch('api/routes/sejours.php', {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    id_séjour: selectedSejourId,
                                    id_chambre: room.id_chambre,
                                    id_agent: JSON.parse(localStorage.getItem('loggedInUser')).id
                                })
                            }).then(response => response.json()).then(result => {
                                if (response.ok) {
                                    //loadManagePatients();
                                    showMessage('تم تحديث رقم الغرفة بنجاح', 'success');
                                } else {
                                    showMessage(result.message, 'error');
                                }
                            });
                        }
                        bootstrap.Modal.getInstance(selectRoomModalAdd).hide();
                    };
                    container.appendChild(roomBtn);
                });

            } catch (error) {
                showMessage('حدث خطأ أثناء تحميل الغرف', 'error');
            }
        }

        /*async function loadManagePatients() {
            try {
                const response = await fetch('api/routes/sejours.php?active=true');
                const patients = await response.json();
                displayPatients(managePatientsTable, patients, true);
            } catch (error) {
                showMessage('حدث خطأ أثناء تحميل المرضى', 'error');
            }
        }*/

        async function loadAllPatients() {
            try {
                const response = await axios('api/routes/patients.php');
                const patients = response.data;
                displayPatients(allPatientsTable, patients, true);
            } catch (error) {
                showMessageAll('حدث خطأ أثناء تحميل المرضى', 'error');
            }
        }

        function displayPatients(table, patientsList, isManageSection) {
            table.innerHTML = '';
            patientsList.forEach(patient => {
                const row = table.insertRow();
                if (isManageSection) {
                    row.innerHTML = `
                        <td>${patient.Nom || '-'}</td>
                        <td>${patient.Prénom || '-'}</td>
                        <td class="room-cell">
                            ${patient.room || '-'}
                            <i class="bi bi-pencil-square room-icon" onclick="openRoomSelection(${patient.id_séjour})" 
                               data-bs-toggle="modal" data-bs-target="#selectRoomModalAdd"></i>
                        </td>
                        <td>${patient.Gender || '-'}</td>
                        <td>${patient.Status || '-'}</td>
                        <td class="notes-cell">
                            <i class="bi bi-eye notes-icon" onclick="viewRecommendations(${patient.id_séjour})" 
                               data-bs-toggle="modal" data-bs-target="#viewRecommendationsModal"></i>
                        </td>
                        <td class="notes-cell">
                            <i class="bi bi-eye notes-icon" onclick="viewPatientDetails(${patient.id_patient})" 
                               data-bs-toggle="modal" data-bs-target="#viewPatientDetailsModal"></i>
                        </td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="updatePatient(${patient.id_patient}, ${patient.id_séjour})" 
                                    data-bs-toggle="modal" data-bs-target="#updatePatientModal">تحديث</button>
                        </td>
                    `;
                } else {
                    row.innerHTML = `
                        <td>${patient.Nom || '-'}</td>
                        <td>${patient.Prénom || '-'}</td>
                        <td>${patient.Date_sortie ? '-' : patient.room || '-'}</td>
                        <td>${patient.Gender || '-'}</td>
                        <td>${patient.Status || '-'}</td>
                        <td>${patient.Date_sortie ? 'غير مفعل' : 'مفعل'}</td>
                        <td>
                            <button class="btn btn-${patient.Date_sortie ? 'success' : 'danger'} btn-sm" 
                                    onclick="togglePatientStatus(${patient.id_séjour})">${patient.Date_sortie ? 'تفعيل' : 'تعطيل'}</button>
                        </td>
                    `;
                }
            });
        }

        function openRoomSelection(sejour_id) {
            selectedSejourId = sejour_id;
            loadAvailableRooms();
        }
        async function saveUpdatedPatient() {
            try {
                const recommendations = [];
                document.querySelectorAll('#recommendations .recommendation-item').forEach(item => {
                    const medication = item.querySelector('input[name="medication[]"]').value.trim();
                    const dosage = item.querySelector('input[name="dosage[]"]').value.trim();
                    if (medication || dosage) recommendations.push({ medication, dosage });
                });

                const patientData = {
                    id_séjour: selectedSejourId,
                    status: document.getElementById('updateStatus').value,
                    recommendations: recommendations,
                    diagnosis: document.getElementById('updateDiagnosis').value.trim(),
                    treatment_method: document.getElementById('updateTreatmentMethod').value.trim(),
                    temperature: parseFloat(document.getElementById('updateTemperature').value) || null,
                    heart_rate: parseInt(document.getElementById('updateHeartRate').value) || null,
                    respiratory_rate: parseInt(document.getElementById('updateRespiratoryRate').value) || null,
                    blood_pressure: document.getElementById('updateBloodPressure').value.trim() || null,
                    oxygen_saturation: parseInt(document.getElementById('updateOxygenSaturation').value) || null,
                    weight: parseFloat(document.getElementById('updateWeight').value) || null,
                    height: parseInt(document.getElementById('updateHeight').value) || null,
                    id_infirmier: JSON.parse(localStorage.getItem('loggedInUser')).id
                };

                if (!patientData.status) {
                    throw new Error('يرجى تحديد حالة المريض');
                }

                const sejourResponse = await fetch('api/routes/sejours.php', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id_séjour: selectedSejourId,
                        Status: patientData.status,
                        Diagnosis: patientData.diagnosis,
                        Treatment_method: patientData.treatment_method
                    })
                });

                if (sejourResponse.ok) {
                    await fetch('api/routes/prescriptions.php', {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id_séjour: selectedSejourId })
                    });

                    for (const rec of recommendations) {
                        await fetch('api/routes/prescriptions.php', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                Date_prescription: new Date().toISOString().split('T')[0],
                                Médicament: rec.medication,
                                Dosage: rec.dosage,
                                id_séjour: selectedSejourId
                            })
                        });
                    }

                    await fetch('api/routes/suivis.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            Date_observation: new Date().toISOString().split('T')[0],
                            Heure_d_observation: new Date().toTimeString().split(' ')[0],
                            État_santé: patientData.status,
                            Tension_artérielle: patientData.blood_pressure,
                            Température: patientData.temperature,
                            Fréquence_cardiaque: patientData.heart_rate,
                            Saturation_oxygène: patientData.oxygen_saturation,
                            Poids: patientData.weight,
                            Taille: patientData.height,
                            id_séjour: selectedSejourId,
                            id_infirmier: patientData.id_infirmier
                        })
                    });

                    //loadManagePatients();
                    loadAllPatients();
                    const modal = bootstrap.Modal.getInstance(updatePatientModal);
                    modal.hide();
                    showMessage('تم تحديث بيانات المريض بنجاح', 'success');
                } else {
                    const result = await sejourResponse.json();
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                showMessage('حدث خطأ أثناء التحديث: ' + error.message, 'error');
            }
        }

        async function togglePatientStatus(id) {
            try {
                const response = await fetch('api/routes/sejours.php', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id_séjour: id,
                        Date_sortie: new Date().toISOString().split('T')[0]
                    })
                });

                const result = await response.json();
                if (response.ok) {
                    //loadManagePatients();
                    loadAllPatients();
                    showMessageAll('تم تعطيل المريض بنجاح', 'success');
                } else {
                    showMessageAll(result.message, 'error');
                }
            } catch (error) {
                showMessageAll('حدث خطأ أثناء تغيير حالة المريض', 'error');
            }
        }

        async function viewRecommendations(id_séjour) {
            try {
                // Get all prescriptions
                const prescriptionsRes = await axios.get('api/routes/prescriptions.php');
                const allPrescriptions = prescriptionsRes.data;

                // Filter prescriptions for this stay
                const recommendations = Array.isArray(allPrescriptions)
                    ? allPrescriptions.filter(p => p.id_séjour == id_séjour)
                    : [];

                // Get sejour details
                const sejourRes = await axios.get(`api/routes/sejours.php?id=${id_séjour}`);
                const sejour = sejourRes.data;

                const content = document.getElementById('viewRecommendationsContent');
                content.innerHTML = `
            <div class="update-info">
                <strong>آخر تحديث:</strong> ${sejour.Updated_at ? new Date(sejour.Updated_at).toLocaleString('ar-SA') : '-'}<br>
                <strong>بواسطة:</strong> ${sejour.nurse_name || '-'}
            </div>
            <h5>الإجراءات المعمول بها:</h5>
            <h6>الأدوية:</h6>
            <ul>
                ${recommendations.length > 0
                        ? recommendations.map(r => `<li>${r.Médicament || '-'} - ${r.Dosage || '-'}</li>`).join('')
                        : '<li>لا توجد توصيات</li>'
                    }
            </ul>
            <h6>التشخيص:</h6>
            <p>${sejour.Diagnosis || '-'}</p>
            <h6>طريقة العلاج:</h6>
            <p>${sejour.Treatment_method || '-'}</p>
        `;

                document.getElementById('viewRecommendationsModalLabel').textContent =
                    `التوصيات الطبية لـ ${sejour.Nom || ''} ${sejour.Prénom || ''}`;
            } catch (error) {
                console.error('Error loading recommendations:', error);
                showMessage('حدث خطأ أثناء تحميل التوصيات', 'error');
            }
        }




        async function viewPatientDetails(id) {
            try {
                const response = await axios('api/routes/patients.php');
                const patients = response.data;
                const patient = patients.find(p => p.id_patient === id);
                if (patient) {
                    const content = document.getElementById('viewPatientDetailsContent');
                    content.innerHTML = `
                        <div class="patient-details-container">
                            <div class="patient-details-section">
                                <h6>المعلومات الشخصية</h6>
                                <p><strong>رقم التعريف:</strong> ${patient.NIN || '-'}</p>
                                <p><strong>رقم الهاتف:</strong> ${patient.Tel || '-'}</p>
                                <p><strong>الجنس:</strong> ${patient.Gender || '-'}</p>
                                <p><strong>تاريخ الميلاد:</strong> ${patient.Birth_date || '-'}</p>
                                <p><strong>زمرة الدم:</strong> ${patient.Blood_type || '-'}</p>
                            </div>
                            <div class="patient-details-section">
                                <h6>البيانات الحيوية</h6>
                                <p><strong>درجة الحرارة:</strong> ${patient.Température ? patient.Température + ' °C' : '-'}</p>
                                <p><strong>معدل ضربات القلب:</strong> ${patient.Fréquence_cardiaque ? patient.Fréquence_cardiaque + ' نبضة/دقيقة' : '-'}</p>
                                <p><strong>معدل التنفس:</strong> ${patient.respiratory_rate ? patient.respiratory_rate + ' نفس/دقيقة' : '-'}</p>
                                <p><strong>ضغط الدم:</strong> ${patient.Tension_artérielle || '-'}</p>
                                <p><strong>نسبة الأكسجين:</strong> ${patient.Saturation_oxygène ? patient.Saturation_oxygène + '%' : '-'}</p>
                                <p><strong>الوزن:</strong> ${patient.Poids ? patient.Poids + ' كجم' : '-'}</p>
                                <p><strong>الطول:</strong> ${patient.Taille ? patient.Taille + ' سم' : '-'}</p>
                            </div>
                        </div>
                    `;
                    document.getElementById('viewPatientDetailsModalLabel').textContent = `تفاصيل المريض: ${patient.Nom} ${patient.Prénom}`;
                }
            } catch (error) {
                console.log(error);
                showMessage('حدث خطأ أثناء تحميل تفاصيل المريض', 'error');
            }
        }

        function addRecommendation(containerId, medication = '', dosage = '') {
            const recommendationsDiv = document.getElementById(containerId);
            const item = document.createElement('div');
            item.className = 'input-group mb-2 recommendation-item';
            item.innerHTML = `
                <input type="text" class="form-control" placeholder="الدواء" name="medication[]" value="${medication}">
                <input type="text" class="form-control" placeholder="الجرعة" name="dosage[]" value="${dosage}">
                <button type="button" class="btn btn-outline-danger" onclick="removeRecommendation(this)">حذف</button>
            `;
            recommendationsDiv.appendChild(item);
        }

        function removeRecommendation(button) {
            button.parentElement.remove();
        }

        function searchPatients(sectionId) {
            const searchTerm = sectionId === 'manage-patients' ? document.getElementById('searchBar').value.trim().toLowerCase() : document.getElementById('searchBarAll').value.trim().toLowerCase();
            fetch(`api/routes/patients.php?search=${encodeURIComponent(searchTerm)}`)
                .then(response => response.json())
                .then(patients => {
                    if (sectionId === 'manage-patients') {
                        const filteredPatients = patients.filter(p => !p.Date_sortie);
                        displayPatients(managePatientsTable, filteredPatients, true);
                    } else {
                        displayPatients(allPatientsTable, patients, false);
                    }
                })
                .catch(error => {
                    showMessage('حدث خطأ أثناء البحث', 'error');
                });
        }

        function logout() {
            localStorage.removeItem('loggedInUser');
            window.location.href = '/';
        }
        toggleSidebarBtn.addEventListener('click', () => {
            sidebar.classList.toggle('active');
            content.classList.toggle('sidebar-active');
        });

        addButton.addEventListener('click', () => {
            if (!document.getElementById('addRoom').value.trim()) {
                showMessage('يرجى اختيار غرفة قبل إضافة المريض', 'error');
                return;
            }
            addPatient();
        });

        updateButton.addEventListener('click', saveUpdatedPatient);

        document.getElementById('searchBar').addEventListener('input', () => searchPatients('manage-patients'));
        document.getElementById('searchBarAll').addEventListener('input', () => searchPatients('all-patients'));

        selectRoomModalAdd.addEventListener('show.bs.modal', () => loadAvailableRooms(true));


        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            const selected = document.getElementById(sectionId);
            if (selected) selected.classList.add('active');
        }

        window.onload = () => {
            //loadManagePatients();
            loadAllPatients();
        };

    </script>
</body>

</html>